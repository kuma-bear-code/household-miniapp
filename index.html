<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>家計簿</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<style>
body{margin:0;background:#f6f7f9;font-family:system-ui}
.wrap{max-width:760px;margin:auto;padding:16px 16px 96px}
.card{background:#fff;border-radius:16px;padding:14px;margin:12px 0;box-shadow:0 6px 22px rgba(0,0,0,.06)}
button{height:42px;border-radius:12px;border:1px solid #ccc;background:#fff}
.primary{background:#1DB446;color:#fff;border-color:#1DB446;font-weight:700}
.danger{border-color:#f2b8b5;color:#d92d20;font-weight:700}
table{width:100%;border-collapse:collapse}
th,td{border-bottom:1px solid #eee;padding:8px;font-size:13px}
th{color:#667085;text-align:left}
.right{text-align:right}
.small{font-size:12px;color:#667085}
</style>
</head>

<body>
<div class="wrap">

<div class="card">
  <div id="status">初期化中…</div>
  <div class="small" id="detail"></div>
</div>

<!-- 入力 -->
<div class="card">
  <b>入力</b><br><br>
  <select id="item"></select><br><br>
  <input id="amount" placeholder="金額"><br><br>
  <select id="memo1">
    <option>かずき</option>
    <option>かずきカード</option>
    <option>みく</option>
    <option>みくカード</option>
  </select><br><br>
  <input id="memo2" placeholder="メモ"><br><br>

  <button class="primary" onclick="add()">追加</button>
  <button class="danger" id="undoBtn" onclick="undo()" disabled>取り消し</button>
</div>

<!-- サマリ -->
<div class="card">
  <b>今月サマリ</b>
  <table>
    <thead>
      <tr>
        <th>項目</th>
        <th class="right">予定</th>
        <th class="right">合計</th>
        <th class="right">残額</th>
      </tr>
    </thead>
    <tbody id="summaryBody">
      <tr><td colspan="4" class="small">未取得</td></tr>
    </tbody>
  </table>
</div>

<!-- 明細 -->
<div class="card">
  <b>明細</b>
  <table>
    <thead>
      <tr>
        <th>日付</th>
        <th>項目</th>
        <th class="right">金額</th>
        <th>メモ</th>
      </tr>
    </thead>
    <tbody id="breakdown"></tbody>
  </table>
</div>

</div>

<script>
const GAS="https://script.google.com/macros/s/AKfycbwCRPyhJLCWkw_F-pm177DGUgq2R_sTVPZLzXuotaJZ6B6R53vDBVpuKXUfYb_N6P_2Eg/exec";
const LIFF_ID="2008812269-var864Dv";
let token=null;
let lastAddSucceeded=false;

const ITEMS=[
 '住居費','駐車場代','貯金','食費','外食費','日用品費','その他生活費','お酒'
];

function $(id){return document.getElementById(id);}
function setStatus(t){$("status").textContent=t;}
function formatMMDD(s){
 const m=s.match(/(\d{4}).?(\d{2}).?(\d{2})/);
 return m?`${Number(m[2])}月${Number(m[3])}日`:s;
}

async function init(){
 ITEMS.forEach(v=>{
  const o=document.createElement("option");o.text=v;$("item").appendChild(o);
 });
 await liff.init({liffId:LIFF_ID});
 if(!liff.isLoggedIn()){liff.login();return;}
 token=liff.getAccessToken();
 setStatus("ログインOK");
 loadSummary();
 loadBreakdown();
}

async function getJson(url){
 const r=await fetch(url);return JSON.parse(await r.text());
}
async function post(body){
 const r=await fetch(GAS+"?action=api",{method:"POST",body:JSON.stringify(body)});
 return JSON.parse(await r.text());
}

async function add(){
 setStatus("追加中…");
 lastAddSucceeded=false;
 $("undoBtn").disabled=true;

 const res=await post({
  op:"add",access_token:token,
  item:$("item").value,
  amount:Number($("amount").value),
  memo1:$("memo1").value,
  memo2:$("memo2").value
 });

 if(res.ok){
  setStatus("追加OK");
  lastAddSucceeded=true;
  $("undoBtn").disabled=false;
  loadSummary(); loadBreakdown();
 }else{
  setStatus("追加NG："+res.error);
 }
}

async function undo(){
 if(!lastAddSucceeded) return;
 setStatus("取り消し中…");
 const res=await post({op:"undo",access_token:token});
 if(res.ok){
  setStatus("取り消しました");
  $("undoBtn").disabled=true;
  lastAddSucceeded=false;
  loadSummary(); loadBreakdown();
 }else{
  setStatus("取り消しNG");
 }
}

async function loadSummary(){
 const r=await getJson(GAS+"?action=api&op=summary&access_token="+token);
 const tb=$("summaryBody"); tb.innerHTML="";
 (r.items||[]).forEach(i=>{
  const rest=i.planned-i.actual;
  tb.innerHTML+=`<tr>
    <td>${i.item}</td>
    <td class="right">${i.planned.toLocaleString()}</td>
    <td class="right">${i.actual.toLocaleString()}</td>
    <td class="right">${rest.toLocaleString()}</td>
  </tr>`;
 });
}

async function loadBreakdown(){
 const r=await getJson(GAS+"?action=api&op=breakdown&access_token="+token);
 const tb=$("breakdown"); tb.innerHTML="";
 (r.rows||[]).forEach(v=>{
  tb.innerHTML+=`<tr>
    <td>${formatMMDD(v[0])}</td>
    <td>${v[1]}</td>
    <td class="right">${v[2]}</td>
    <td>${v[3]||""} ${v[4]||""}</td>
  </tr>`;
 });
}

window.onload=init;
</script>
</body>
</html>
