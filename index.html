  <!doctype html>
  <html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
    <title>家計簿</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
      :root{
        --bg:#0b0c10; --card:#12141a; --muted:#9aa3b2; --text:#eef2ff;
        --line:#232735; --accent:#4f7cff;
        --good:#2cdd9b; --warn:#ffcc66; --bad:#ff5c7a;
      }
      body{ margin:0; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"Hiragino Kaku Gothic ProN","Noto Sans JP",sans-serif; background:var(--bg); color:var(--text); }
      header{
        padding:16px 16px 10px; position:sticky; top:0;
        background:linear-gradient(180deg, rgba(11,12,16,.98), rgba(11,12,16,.85));
        backdrop-filter: blur(10px); border-bottom:1px solid var(--line); z-index:10;
      }
      .headrow{ display:flex; align-items:flex-start; justify-content:space-between; gap:10px; }
      h1{ margin:0; font-size:18px; letter-spacing:.02em; }
      .sub{ margin-top:6px; font-size:12px; color:var(--muted); }
      .pillrow{ display:flex; gap:8px; align-items:center; justify-content:flex-end; flex-wrap:wrap; }
      .pill{
        font-size:12px; padding:6px 10px; border-radius:999px;
        border:1px solid var(--line); background:rgba(18,20,26,.7);
        color:var(--text); white-space:nowrap;
      }
      .pill.ok{ border-color:#2c3350; }
      .pill.muted{ color:var(--muted); }
      .pill.good{ border-color:rgba(44,221,155,.45); color:var(--good); }
      .pill.warn{ border-color:rgba(255,204,102,.45); color:var(--warn); }
      .pill.bad{ border-color:rgba(255,92,122,.45); color:var(--bad); }
  
      .wrap{ padding:14px 14px 40px; max-width:860px; margin:0 auto; }
      .tabs{ display:flex; gap:8px; margin:10px 0 14px; }
      .tab{ flex:1; background:transparent; border:1px solid var(--line); color:var(--text); padding:10px 8px; border-radius:12px; font-weight:600; }
      .tab.active{ background:var(--card); border-color:#2c3350; }
      .card{ background:var(--card); border:1px solid var(--line); border-radius:16px; padding:14px; margin:12px 0; }
      .row{ display:flex; gap:10px; flex-wrap:wrap; }
      label{ font-size:12px; color:var(--muted); display:block; margin-bottom:6px; }
      select,input,textarea{ width:100%; box-sizing:border-box; background:#0f1117; border:1px solid #2a2f40; color:var(--text); border-radius:12px; padding:10px 12px; font-size:14px; outline:none; }
      textarea{ min-height:70px; }
      .btn{ background:var(--accent); border:none; color:white; padding:11px 14px; border-radius:12px; font-weight:700; }
      .btn.sub{ background:transparent; border:1px solid var(--line); color:var(--text); }
      .btn:disabled{ opacity:.5; }
      .hint{ font-size:12px; color:var(--muted); margin-top:8px; line-height:1.5; }
      table{ width:100%; border-collapse:collapse; font-size:13px; }
      th,td{ border-bottom:1px solid var(--line); padding:10px 6px; text-align:left; vertical-align:top; }
      th{ color:var(--muted); font-weight:700; font-size:12px; }
      td.num{ text-align:right; white-space:nowrap; }
      .kpi{ display:flex; justify-content:space-between; align-items:baseline; gap:8px; }
      .kpi b{ font-size:22px; }
      .kpi span{ color:var(--muted); font-size:12px; }
      .msg{ white-space:pre-wrap; font-size:12px; color:#cbd5ff; margin-top:10px; padding:10px; border:1px dashed #2a2f40; border-radius:12px; background:#0f1117; }
  
      /* chart list */
      .chartList{ display:flex; flex-direction:column; gap:12px; }
      .chartItemTitle{ font-size:13px; font-weight:800; color:#dbe4ff; margin-bottom:8px; }
      .chartImg{
        width:100%; border-radius:14px; border:1px solid var(--line); background:#0f1117;
        cursor:pointer;
      }
  
      /* modal */
      .modalBackdrop{
        position:fixed; inset:0; background:rgba(0,0,0,.75);
        display:none; align-items:center; justify-content:center; z-index:999;
        padding:16px;
      }
      .modalBackdrop.show{ display:flex; }
      .modalCard{
        width:min(980px, 100%); background:#0f1117; border:1px solid #2a2f40;
        border-radius:16px; padding:10px;
      }
      .modalTop{ display:flex; justify-content:space-between; align-items:center; gap:8px; margin-bottom:8px; }
      .modalTop .title{ font-weight:800; font-size:14px; color:#eef2ff; }
      .modalTop button{
        background:transparent; border:1px solid var(--line); color:var(--text);
        padding:6px 10px; border-radius:10px; font-weight:700;
      }
      .modalImg{ width:100%; border-radius:12px; border:1px solid var(--line); background:#0b0c10; }
  
      .tiny{ font-size:11px; color:var(--muted); margin-top:6px; }
    </style>
  </head>
  <body>
  <header>
    <div class="headrow">
      <div>
        <h1>家計簿</h1>
        <div class="sub" id="who">initializing…</div>
      </div>
      <div class="pillrow">
        <div class="pill ok" id="loginPill">未ログイン</div>
        <div class="pill muted" id="statePill">待機</div>
      </div>
    </div>
  </header>
  
  <div class="wrap">
    <div class="tabs">
      <button class="tab active" data-tab="add">追加</button>
      <button class="tab" data-tab="summary">合計</button>
      <button class="tab" data-tab="breakdown">内訳</button>
      <button class="tab" data-tab="chart">グラフ</button>
    </div>
  
    <!-- 追加 -->
    <section id="tab-add">
      <div class="card">
        <div class="row">
          <div style="flex:1; min-width:220px;">
            <label>月（YYYYMM）</label>
            <input id="monthAdd" placeholder="例: 202601" />
            <div class="hint">空欄なら当月。</div>
          </div>
          <div style="flex:2; min-width:260px;">
            <label>項目</label>
            <select id="itemSel"></select>
          </div>
        </div>
  
        <div class="row">
          <div style="flex:1; min-width:180px;">
            <label>金額</label>
            <input id="amount" inputmode="numeric" placeholder="例: 1200" />
          </div>
          <div style="flex:1; min-width:180px;">
            <label>備考1</label>
            <select id="memo1Sel"></select>
          </div>
        </div>
  
        <div class="row">
          <div style="flex:1; min-width:280px;">
            <label>備考2</label>
            <input id="memo2" placeholder="任意" />
          </div>
        </div>
  
        <div class="row" style="margin-top:8px;">
          <button class="btn" id="btnAdd">追加</button>
          <button class="btn sub" id="btnUndo">直前取り消し</button>
        </div>
  
        <div class="msg" id="msgAdd" style="display:none;"></div>
      </div>
    </section>
  
    <!-- 合計 -->
    <section id="tab-summary" style="display:none;">
      <div class="card">
        <div class="row">
          <div style="flex:1; min-width:220px;">
            <label>月（YYYYMM）</label>
            <input id="monthSum" placeholder="例: 202601" />
            <div class="hint">空欄なら当月。</div>
          </div>
          <div style="display:flex; align-items:flex-end; gap:10px;">
            <button class="btn" id="btnSum">取得</button>
          </div>
        </div>
  
        <div class="card" style="margin-top:12px;">
          <div class="kpi"><span>全体の残額</span><b id="overall">-</b></div>
        </div>
  
        <div class="card" style="margin-top:12px;">
          <table>
            <thead>
              <tr><th>項目</th><th class="num">予算</th><th class="num">支出</th><th class="num">残額</th></tr>
            </thead>
            <tbody id="sumBody"></tbody>
          </table>
        </div>
  
        <div class="msg" id="msgSum" style="display:none;"></div>
      </div>
    </section>
  
    <!-- 内訳 -->
    <section id="tab-breakdown" style="display:none;">
      <div class="card">
        <div class="row">
          <div style="flex:1; min-width:220px;">
            <label>月（YYYYMM）</label>
            <input id="monthBd" placeholder="例: 202601" />
          </div>
          <div style="flex:1; min-width:120px;">
            <label>開始</label>
            <input id="startBd" inputmode="numeric" value="0" />
          </div>
          <div style="flex:1; min-width:120px;">
            <label>件数</label>
            <input id="limitBd" inputmode="numeric" value="50" />
          </div>
          <div style="display:flex; align-items:flex-end; gap:10px;">
            <button class="btn" id="btnBd">取得</button>
            <button class="btn sub" id="btnBdMore">次へ</button>
          </div>
        </div>
  
        <div class="card" style="margin-top:12px;">
          <table>
            <thead>
              <tr><th>日付</th><th>項目</th><th class="num">金額</th><th>備考1</th><th>備考2</th></tr>
            </thead>
            <tbody id="bdBody"></tbody>
          </table>
          <div class="hint" id="bdInfo"></div>
        </div>
  
        <div class="msg" id="msgBd" style="display:none;"></div>
      </div>
    </section>
  
    <!-- グラフ -->
    <section id="tab-chart" style="display:none;">
      <div class="card">
        <div class="row">
          <div style="flex:1; min-width:220px;">
            <label>月（YYYYMM）</label>
            <input id="monthChart" placeholder="例: 202601" />
            <div class="hint">空欄なら当月。</div>
          </div>
          <div style="display:flex; align-items:flex-end; gap:10px; flex-wrap:wrap;">
            <button class="btn" id="btnChartList">一覧表示</button>
            <button class="btn sub" id="btnDebug">debug</button>
            <button class="btn sub" id="btnCancel">中断</button>
          </div>
        </div>
  
        <div class="hint" id="chartHint">※ 全体残額→項目順（base64で確実表示）</div>
        <div class="tiny">debugは <code>op=debug_sheet</code> がGAS側にある時だけ有効。</div>
  
        <div class="card" style="margin-top:12px;">
          <div id="chartList" class="chartList"></div>
        </div>
  
        <div class="msg" id="msgChart" style="display:none;"></div>
      </div>
    </section>
  </div>
  
  <!-- modal -->
  <div class="modalBackdrop" id="imgModal">
    <div class="modalCard">
      <div class="modalTop">
        <div class="title" id="modalTitle">画像</div>
        <button id="modalClose">閉じる</button>
      </div>
      <img id="modalImg" class="modalImg" alt="modal" />
    </div>
  </div>
  
  <script>
    // ============================
    // 設定：ここをあなたの値に変更
    // ============================
    const LIFF_ID = "2008812269-var864Dv";
    const API_BASE = "https://script.google.com/macros/s/AKfycbwCRPyhJLCWkw_F-pm177DGUgq2R_sTVPZLzXuotaJZ6B6R53vDBVpuKXUfYb_N6P_2Eg/exec"; // 末尾 /exec まで
  
    // ===== UI状態 =====
    function setState(text, level="muted"){
      const el = document.getElementById("statePill");
      el.textContent = text;
      el.className = "pill " + (level || "muted");
    }
    function setLogin(text, level="ok"){
      const el = document.getElementById("loginPill");
      el.textContent = text;
      el.className = "pill " + (level || "ok");
    }
  
    // ===== util =====
    function currentYYYYMM(){
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      return `${y}${m}`;
    }
    function money(n){
      const x = Number(n||0);
      return x.toLocaleString();
    }
    function showMsg(id, obj){
      const el = document.getElementById(id);
      el.style.display = "block";
      el.textContent = typeof obj === "string" ? obj : JSON.stringify(obj, null, 2);
    }
    function hideMsg(id){
      const el = document.getElementById(id);
      el.style.display = "none";
      el.textContent = "";
    }
  
    // ===== Abort制御（中断ボタン用）=====
    let activeController = null;
    function newController(){
      if (activeController) try{ activeController.abort(); }catch(e){}
      activeController = new AbortController();
      return activeController;
    }
    function abortActive(){
      if (activeController) {
        try{ activeController.abort(); }catch(e){}
        activeController = null;
      }
    }
  
    // timeout付きfetch（デフォルト90秒）
    async function fetchWithTimeout(url, opts={}, timeoutMs=90000, controller=null){
      const ac = controller || new AbortController();
      const t = setTimeout(()=>ac.abort(), timeoutMs);
      try{
        const res = await fetch(url, {...opts, signal: ac.signal});
        return res;
      } finally {
        clearTimeout(t);
      }
    }
  
    async function readRes(res){
      const ct = (res.headers.get("content-type")||"").toLowerCase();
      const text = await res.text();
      if (ct.includes("application/json")) {
        try { return JSON.parse(text); } catch(e){ return { ok:false, error:"JSON parse failed", raw:text }; }
      }
      try { return JSON.parse(text); } catch(e){ return { ok:false, error:"Non-JSON response", raw:text }; }
    }
  
    // ===== API wrapper =====
    let accessToken = "";
    let myUserId = "";
  
    async function apiGet(op, params={}, timeoutMs=90000, controller=null){
      const qs = new URLSearchParams({
        action:"api",
        op,
        access_token: accessToken,
        ...params
      });
      const url = `${API_BASE}?${qs.toString()}`;
      const res = await fetchWithTimeout(url, { method:"GET" }, timeoutMs, controller);
      const data = await readRes(res);
      if (!res.ok || !data.ok) throw new Error(data.error || `HTTP ${res.status}`);
      return data;
    }
  
    async function apiPost(body, timeoutMs=45000, controller=null){
      const url = `${API_BASE}?action=api`;
      const res = await fetchWithTimeout(url, {
        method:"POST",
        // preflight回避
        headers: { "Content-Type":"text/plain;charset=UTF-8" },
        body: JSON.stringify(body)
      }, timeoutMs, controller);
      const data = await readRes(res);
      if (!res.ok || !data.ok) throw new Error(data.error || `HTTP ${res.status}`);
      return data;
    }
  
    // ===== init =====
    async function init(){
      setState("初期化中…","warn");
      setLogin("未ログイン","ok");
  
      await liff.init({ liffId: LIFF_ID });
  
      if (!liff.isLoggedIn()){
        setLogin("未ログイン","ok");
        liff.login();
        return;
      }
      setLogin("ログイン済み","good");
      accessToken = liff.getAccessToken();
  
      // whoami
      try{
        const me = await apiGet("whoami", {}, 25000);
        myUserId = me.userId;
        document.getElementById("who").textContent = `user: ${myUserId}`;
      }catch(e){
        document.getElementById("who").textContent = `init error: ${e.message}`;
        setState("初期化エラー","bad");
      }
  
      // items
      try{
        const r = await apiGet("items", {}, 25000);
        const itemSel = document.getElementById("itemSel");
        itemSel.innerHTML = "";
        r.items.forEach(x=>{
          const opt = document.createElement("option");
          opt.value = x; opt.textContent = x;
          itemSel.appendChild(opt);
        });
  
        const memo1Sel = document.getElementById("memo1Sel");
        memo1Sel.innerHTML = "";
        r.memo1Options.forEach(x=>{
          const opt = document.createElement("option");
          opt.value = x; opt.textContent = x==="" ? "（なし）" : x;
          memo1Sel.appendChild(opt);
        });
      }catch(e){
        showMsg("msgAdd", `items error: ${e.message}`);
      }
  
      // default months
      document.getElementById("monthAdd").value = "";
      document.getElementById("monthSum").value = "";
      document.getElementById("monthBd").value = "";
      document.getElementById("monthChart").value = "";
  
      setState("待機","muted");
    }
  
    // ===== tabs =====
    document.querySelectorAll(".tab").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
        btn.classList.add("active");
        const t = btn.dataset.tab;
        ["add","summary","breakdown","chart"].forEach(k=>{
          document.getElementById(`tab-${k}`).style.display = (k===t) ? "" : "none";
        });
        setState("待機","muted");
      });
    });
  
    // ===== add =====
    document.getElementById("btnAdd").addEventListener("click", async ()=>{
      hideMsg("msgAdd");
      setState("入力中…","warn");
      const item  = document.getElementById("itemSel").value;
      const amount= Number(document.getElementById("amount").value);
      const memo1 = document.getElementById("memo1Sel").value;
      const memo2 = document.getElementById("memo2").value || "";
      const month = (document.getElementById("monthAdd").value || "").trim();
  
      try{
        const r = await apiPost({
          op:"add",
          access_token: accessToken,
          item, amount,
          memo1, memo2,
          month: month || null
        }, 45000);
        showMsg("msgAdd", r);
        setState("完了","good");
      }catch(e){
        showMsg("msgAdd", `add failed: ${e.message}`);
        setState("エラー","bad");
      }
    });
  
    // ===== undo =====
    document.getElementById("btnUndo").addEventListener("click", async ()=>{
      hideMsg("msgAdd");
      setState("取り消し中…","warn");
      try{
        const r = await apiPost({ op:"undo", access_token: accessToken }, 45000);
        showMsg("msgAdd", r);
        setState("完了","good");
      }catch(e){
        showMsg("msgAdd", `undo failed: ${e.message}`);
        setState("エラー","bad");
      }
    });
  
    // ===== summary =====
    document.getElementById("btnSum").addEventListener("click", async ()=>{
      hideMsg("msgSum");
      setState("取得中…","warn");
      const month = (document.getElementById("monthSum").value || "").trim() || currentYYYYMM();
      try{
        const r = await apiGet("summary", { month }, 45000);
        document.getElementById("overall").textContent = money(r.overall) + "円";
  
        const body = document.getElementById("sumBody");
        body.innerHTML = "";
        r.rows.forEach(row=>{
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${row.name}</td>
            <td class="num">${money(row.budget)}円</td>
            <td class="num">${money(row.spend)}円</td>
            <td class="num">${money(row.remain)}円</td>
          `;
          body.appendChild(tr);
        });
        setState("完了","good");
      }catch(e){
        showMsg("msgSum", `summary failed: ${e.message}`);
        setState("エラー","bad");
      }
    });
  
    // ===== breakdown =====
    async function loadBreakdown(){
      hideMsg("msgBd");
      setState("取得中…","warn");
      const month = (document.getElementById("monthBd").value || "").trim() || currentYYYYMM();
      const start = Number(document.getElementById("startBd").value || 0);
      const limit = Number(document.getElementById("limitBd").value || 50);
  
      try{
        const r = await apiGet("breakdown", { month, start, limit }, 45000);
        const body = document.getElementById("bdBody");
        body.innerHTML = "";
        r.rows.forEach(row=>{
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${row.date}</td>
            <td>${row.item}</td>
            <td class="num">${money(row.amount)}円</td>
            <td>${row.memo1 || ""}</td>
            <td>${row.memo2 || ""}</td>
          `;
          body.appendChild(tr);
        });
        document.getElementById("bdInfo").textContent =
          `表示: ${r.start+1}–${r.start + r.rows.length} / ${r.total}` + (r.hasMore ? `  nextStart=${r.nextStart}` : "");
        document.getElementById("btnBdMore").disabled = !r.hasMore;
        document.getElementById("btnBdMore").dataset.nextStart = r.nextStart;
        setState("完了","good");
      }catch(e){
        showMsg("msgBd", `breakdown failed: ${e.message}`);
        setState("エラー","bad");
      }
    }
    document.getElementById("btnBd").addEventListener("click", loadBreakdown);
    document.getElementById("btnBdMore").addEventListener("click", ()=>{
      const ns = Number(document.getElementById("btnBdMore").dataset.nextStart || 0);
      document.getElementById("startBd").value = String(ns);
      loadBreakdown();
    });
  
    // ===== modal =====
    const modal = document.getElementById("imgModal");
    const modalImg = document.getElementById("modalImg");
    const modalTitle = document.getElementById("modalTitle");
    document.getElementById("modalClose").addEventListener("click", ()=>modal.classList.remove("show"));
    modal.addEventListener("click", (e)=>{ if (e.target === modal) modal.classList.remove("show"); });
  
    function openModal(title, src){
      modalTitle.textContent = title || "画像";
      modalImg.src = src;
      modal.classList.add("show");
    }
  
    // ===== chart list (base64) =====
    document.getElementById("btnCancel").addEventListener("click", ()=>{
      abortActive();
      setState("中断","warn");
    });
  
    document.getElementById("btnChartList").addEventListener("click", async ()=>{
  hideMsg("msgChart");
  setState("グラフ取得中…","warn");

  const month = (document.getElementById("monthChart").value || "").trim() || currentYYYYMM();
  const listEl = document.getElementById("chartList");
  listEl.innerHTML = "";

  const ctrl = newController();

  try{
    let start = 0;
    const limit = 6;          // 1回あたりの枚数（GAS落ち防止）
    let first = true;

    while(true){
      const r = await apiGet("chart_list_b64_paged", { month, start, limit }, 120000, ctrl);

      // overall（最初のページだけ）
      if (first && r.overall && r.overall.b64){
        const src = `data:${r.overall.mimeType||"image/png"};base64,${r.overall.b64}`;
        const box = document.createElement("div");
        box.className = "card";
        box.innerHTML = `<div class="chartItemTitle">${r.overall.title || "全体"}</div>`;
        const img = document.createElement("img");
        img.className = "chartImg";
        img.alt = "overall";
        img.src = src;
        img.addEventListener("click", ()=>openModal(r.overall.title || "全体", src));
        box.appendChild(img);
        listEl.appendChild(box);
      }

      // items（このページ分）
      (r.items||[]).forEach((it)=>{
        if (!it || !it.b64) return;
        const src = `data:${it.mimeType||"image/png"};base64,${it.b64}`;
        const box = document.createElement("div");
        box.className = "card";
        box.innerHTML = `<div class="chartItemTitle">${it.title || "-"}</div>`;
        const img = document.createElement("img");
        img.className = "chartImg";
        img.alt = it.title || "item";
        img.src = src;
        img.addEventListener("click", ()=>openModal(it.title || "画像", src));
        box.appendChild(img);
        listEl.appendChild(box);
      });

      first = false;

      if (!r.hasMore) break;
      start = r.nextStart;

      // 連打で落ちるのを防ぐ小休止（地味に効く）
      await new Promise(res => setTimeout(res, 250));
    }

    setState("完了","good");
    activeController = null;

  }catch(e){
    const msg = (e && e.name === "AbortError") ? "fetch is aborted（中断またはタイムアウト）" : e.message;
    showMsg("msgChart", `chart list failed: ${msg}`);
    setState("エラー","bad");
    activeController = null;
  }
});

  
    // ===== debug button =====
    document.getElementById("btnDebug").addEventListener("click", async ()=>{
      hideMsg("msgChart");
      setState("debug中…","warn");
      const month = (document.getElementById("monthChart").value || "").trim() || currentYYYYMM();
      try{
        const dbg = await apiGet("debug_sheet", { month }, 45000);
        showMsg("msgChart", dbg);
        setState("完了","good");
      }catch(e){
        showMsg("msgChart", `debug failed: ${e.message}`);
        setState("エラー","bad");
      }
    });
  
    init().catch(err=>{
      document.getElementById("who").textContent = `init fatal: ${err.message}`;
      setState("エラー","bad");
    });
  </script>
  </body>
  </html>
