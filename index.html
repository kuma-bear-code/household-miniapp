<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>家計簿 MiniApp</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body{font-family:system-ui, -apple-system, "Segoe UI", sans-serif; margin:16px;}
    .row{display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
    select,input,button{font-size:16px; padding:10px;}
    button{cursor:pointer;}
    .card{border:1px solid #ddd; border-radius:12px; padding:12px; margin:12px 0;}
    .muted{color:#666; font-size:13px;}
    .ok{color:#0a7;}
    .ng{color:#c33;}
    img{max-width:100%; border-radius:12px; border:1px solid #ddd;}
  </style>
</head>
<body>
  <h2>家計簿 MiniApp</h2>

  <div class="card">
    <div class="row">
      <button id="btnInit">初期化</button>
      <button id="btnRefresh">⏱ 更新</button>
      <span id="status" class="muted">未初期化</span>
    </div>
    <div id="detail" class="muted" style="margin-top:6px;"></div>
  </div>

  <div class="card">
    <h3>追加</h3>
    <div class="row" style="margin-bottom:8px;">
      <select id="selItem"></select>
      <input id="inpAmount" type="number" inputmode="numeric" placeholder="金額" />
    </div>
    <div class="row" style="margin-bottom:8px;">
      <select id="selMemo1">
        <option value="">（備考1）</option>
        <option value="かずき">かずき</option>
        <option value="かずきカード">かずきカード</option>
        <option value="みく">みく</option>
        <option value="みくカード">みくカード</option>
        <option value="自分で入力">自分で入力</option>
      </select>
      <input id="inpMemo1" placeholder="備考1（自由入力）" style="display:none;" />
      <input id="inpMemo2" placeholder="備考2（任意）" />
      <button id="btnAdd">追加</button>
      <button id="btnUndo">取り消し</button>
    </div>
    <div id="addMsg" class="muted"></div>
  </div>

  <div class="card">
    <h3>合計</h3>
    <div class="row">
      <input id="inpSummaryMonth" placeholder="YYYYMM（空で今月）" />
      <button id="btnSummary">表示</button>
    </div>
    <pre id="summaryOut" style="white-space:pre-wrap;"></pre>
  </div>

  <div class="card">
    <h3>内訳</h3>
    <div class="row">
      <input id="inpBreakMonth" placeholder="YYYYMM（空で今月）" />
      <button id="btnBreak">表示</button>
    </div>
    <pre id="breakOut" style="white-space:pre-wrap;"></pre>
  </div>

  <div class="card">
    <h3>グラフ（全体残額）</h3>
    <div class="row">
      <input id="inpChartMonth" placeholder="YYYYMM（空で今月）" />
      <button id="btnChart">更新</button>
    </div>
    <div id="chartImgWrap" style="margin-top:10px; display:none;">
      <img id="chartImg" alt="chart" />
    </div>
    <div id="chartMsg" class="muted"></div>
  </div>

<script>
  // ★ あなたの環境の値を設定
  const LIFF_ID = "2008812269-var864Dv";
  const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbwCRPyhJLCWkw_F-pm177DGUgq2R_sTVPZLzXuotaJZ6B6R53vDBVpuKXUfYb_N6P_2Eg/exec";

  let accessToken = "";

  const el = (id)=>document.getElementById(id);

  function setState(title, detail, cls=""){
    const st = el("status");
    st.textContent = title;
    st.className = "muted " + cls;
    el("detail").textContent = detail || "";
  }

  function currentYm(){
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    return ""+y+m;
  }

  async function apiGet(op, params={}){
    if (!accessToken) throw new Error("access_token がありません");
    const url = new URL(WEBAPP_URL);
    url.searchParams.set("action","api");
    url.searchParams.set("op", op);
    url.searchParams.set("access_token", accessToken);
    Object.keys(params).forEach(k=>{
      if (params[k] !== undefined && params[k] !== null) url.searchParams.set(k, params[k]);
    });

    const res = await fetch(url.toString(), { method:"GET" });
    const text = await res.text();

    let json;
    try { json = JSON.parse(text); }
    catch { throw new Error("JSON以外が返りました: " + text.slice(0,200)); }

    if (!json.ok) throw new Error(json.error || json.msg || "API error");
    return json;
  }

  // ★ POST不安定対策：add/undo も GET op=add/op=undo に寄せる
  async function apiAdd(body){
    return await apiGet("add", body);
  }
  async function apiUndo(){
    return await apiGet("undo", {});
  }

  async function init(){
    setState("初期化中", "LIFF初期化…");
    await liff.init({ liffId: LIFF_ID });

    if (!liff.isLoggedIn()){
      setState("ログインが必要", "ログインへ遷移します…", "ng");
      liff.login();
      return;
    }

    accessToken = liff.getAccessToken();
    const who = await apiGet("whoami", {});
    setState("準備完了", `userId: ${who.userId}`, "ok");

    // items
    const items = await apiGet("items", {});
    const sel = el("selItem");
    sel.innerHTML = "";
    items.items.forEach(it=>{
      const opt = document.createElement("option");
      opt.value = it;
      opt.textContent = it;
      sel.appendChild(opt);
    });
  }

  function bind(){
    el("btnInit").onclick = ()=>init().catch(e=>setState("失敗", String(e.message||e), "ng"));

    el("btnRefresh").onclick = async ()=>{
      try{
        setState("更新中", "合計/内訳/グラフの更新を実行…");
        await loadSummary();
        await loadBreakdown();
        await loadChart();
        setState("更新完了", "表示を更新しました", "ok");
      }catch(e){
        setState("更新失敗", String(e.message||e), "ng");
      }
    };

    el("selMemo1").onchange = ()=>{
      const v = el("selMemo1").value;
      el("inpMemo1").style.display = (v==="自分で入力") ? "" : "none";
      if (v !== "自分で入力") el("inpMemo1").value = "";
    };

    el("btnAdd").onclick = async ()=>{
      try{
        const item = el("selItem").value;
        const amount = Number(el("inpAmount").value);
        let memo1 = el("selMemo1").value;
        if (memo1 === "自分で入力") memo1 = el("inpMemo1").value.trim();
        if (memo1 === "（備考1）") memo1 = "";
        const memo2 = el("inpMemo2").value.trim();

        setState("通信中", "追加を送信しています…");
        const r = await apiAdd({ item, amount, memo1, memo2, month: currentYm() });

        el("addMsg").textContent = "✅ " + r.msg;
        setState("追加OK", r.msg, "ok");

        // 追加後に再表示
        await loadSummary();
        await loadBreakdown();
        await loadChart();

      }catch(e){
        el("addMsg").textContent = "❌ " + String(e.message||e);
        setState("追加失敗", String(e.message||e), "ng");
      }
    };

    el("btnUndo").onclick = async ()=>{
      try{
        setState("通信中", "取り消しを実行しています…");
        const r = await apiUndo();
        el("addMsg").textContent = (r.ok ? "✅ " : "❌ ") + r.msg;
        setState("取り消し結果", r.msg, r.ok ? "ok" : "ng");
        await loadSummary();
        await loadBreakdown();
        await loadChart();
      }catch(e){
        setState("取り消し失敗", String(e.message||e), "ng");
      }
    };

    el("btnSummary").onclick = ()=>loadSummary().catch(e=>setState("合計失敗", String(e.message||e), "ng"));
    el("btnBreak").onclick = ()=>loadBreakdown().catch(e=>setState("内訳失敗", String(e.message||e), "ng"));
    el("btnChart").onclick = ()=>loadChart().catch(e=>setState("グラフ失敗", String(e.message||e), "ng"));
  }

  async function loadSummary(){
    const month = (el("inpSummaryMonth").value || "").trim() || currentYm();
    const r = await apiGet("summary", { month });

    const lines = [];
    lines.push(`【${month} 合計】 全体残額: ${Number(r.overall||0).toLocaleString()}円`);
    r.rows.forEach(x=>{
      lines.push(`${x.name}  予算:${Number(x.budget||0).toLocaleString()}  支出:${Number(x.spend||0).toLocaleString()}  残額:${Number(x.remain||0).toLocaleString()}`);
    });
    el("summaryOut").textContent = lines.join("\n");
  }

  async function loadBreakdown(){
    const month = (el("inpBreakMonth").value || "").trim() || currentYm();
    const r = await apiGet("breakdown", { month, start:0, limit:50 });

    const fmt = (d)=>{
      // Date or string を "MM/dd" に寄せる
      try{
        const dd = new Date(d);
        if (!isNaN(dd.getTime())){
          const m = String(dd.getMonth()+1).padStart(2,"0");
          const day = String(dd.getDate()).padStart(2,"0");
          return `${m}/${day}`;
        }
      }catch(_){}
      return String(d);
    };

    const lines = [];
    lines.push(`【${month} 内訳】 件数:${r.total}`);
    r.rows.forEach((x,i)=>{
      lines.push(`${i+1}. ${fmt(x.date)}  ${x.item}  ${Number(x.amount||0).toLocaleString()}円  ${x.memo1||""}  ${x.memo2||""}`);
    });
    el("breakOut").textContent = lines.join("\n");
  }

  async function loadChart(){
    const month = (el("inpChartMonth").value || "").trim() || currentYm();
    el("chartMsg").textContent = "更新中…";

    const r = await apiGet("chart_overall", { month });
    const img = el("chartImg");
    const wrap = el("chartImgWrap");

    wrap.style.display = "none";
    img.onload = ()=>{ wrap.style.display=""; el("chartMsg").textContent = "✅ グラフを更新しました"; };
    img.onerror = ()=>{ el("chartMsg").textContent = "❌ 画像は読み込めませんでした"; };

    // ★ 同一オリジン配信URL（GASが image/jpeg で返す）なのでLIFFで安定
    img.src = r.url + "&cache=" + Date.now();
  }

  bind();
  setState("未初期化", "「初期化」を押してください");
</script>
</body>
</html>
