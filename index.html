<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>家計簿ミニアプリ（検証）</title>

  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif; margin: 16px; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 12px; margin: 12px 0; }
    .row { display: flex; gap: 8px; flex-wrap: wrap; }
    button { padding: 10px 12px; border-radius: 10px; border: 1px solid #ccc; background: #fff; cursor: pointer; }
    button.primary { background: #1DB446; color: #fff; border-color: #1DB446; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    pre { background:#111; color:#ddd; padding:12px; border-radius:12px; overflow:auto; }
    .muted { color:#666; font-size: 12px; }
    .ok { color:#1b8f3a; font-weight: 700; }
    .ng { color:#c62828; font-weight: 700; }
    input { padding:10px 12px; border-radius:10px; border:1px solid #ccc; width: 100%; box-sizing: border-box;}
  </style>
</head>

<body>
  <h2>家計簿ミニアプリ（whoami確認）</h2>
  <div class="muted">
    目的：LIFFで取得した idToken を GAS に渡し、ユーザー識別（sub/userId）を確認します。
  </div>

  <div class="card">
    <div><b>ステータス</b></div>
    <div id="status">初期化中…</div>
    <div class="muted" id="detail"></div>
  </div>

  <div class="card">
    <div><b>接続先</b></div>
    <div class="muted">GAS WebApp URL</div>
    <input id="gasUrl" />
    <div class="muted" style="margin-top:8px;">LIFF ID</div>
    <input id="liffId" />
    <div class="muted" style="margin-top:8px;">
      ※ まずはこのまま触らずOK。将来URLを変える時に使えます。
    </div>
  </div>

  <div class="card">
    <div class="row">
      <button class="primary" id="btnWhoami" onclick="whoami()" disabled>whoami（本人確認）</button>
      <button id="btnProfile" onclick="showProfile()" disabled>プロフィール表示</button>
      <button id="btnClose" onclick="closeLiff()" disabled>閉じる</button>
      <button onclick="copyDebug()">デバッグ情報コピー</button>
    </div>
    <div class="muted" style="margin-top:8px;">
      「whoami」で userId(sub) が返ればOK。実久さんも同じ手順で userId を取って許可リストに追加できます。
    </div>
  </div>

  <div class="card">
    <div><b>レスポンス</b></div>
    <pre id="output">（ここに結果が出ます）</pre>
  </div>

<script>
  // ===== 固定（あなたの値で埋め込み済み） =====
  const DEFAULT_GAS_URL = "https://script.google.com/macros/s/AKfycbwCRPyhJLCWkw_F-pm177DGUgq2R_sTVPZLzXuotaJZ6B6R53vDBVpuKXUfYb_N6P_2Eg/exec";
  const DEFAULT_LIFF_ID = "2008812269-var864Dv";

  // ===== 状態 =====
  let idToken = null;
  let accessToken = null; 
  let profile = null;

  // ===== UI =====
  const $ = (id) => document.getElementById(id);
  function setStatus(text, ok=null) {
    const el = $("status");
    el.textContent = text;
    el.className = ok === null ? "" : (ok ? "ok" : "ng");
  }
  function setDetail(text) { $("detail").textContent = text || ""; }
  function setOutput(objOrText) {
    $("output").textContent = (typeof objOrText === "string")
      ? objOrText
      : JSON.stringify(objOrText, null, 2);
  }

  function enableButtons(enabled) {
    $("btnWhoami").disabled = !enabled;
    $("btnProfile").disabled = !enabled;
    $("btnClose").disabled = !enabled;
  }

  // ===== LIFF 初期化 =====
  async function init() {
    $("gasUrl").value = DEFAULT_GAS_URL;
    $("liffId").value = DEFAULT_LIFF_ID;

    try {
      setStatus("LIFF 初期化中…");
      await liff.init({ liffId: DEFAULT_LIFF_ID });

      if (!liff.isLoggedIn()) {
        setStatus("LINEログインが必要です。ログイン画面に移動します…");
        setDetail("");
        liff.login();
        return;
      }

      idToken = liff.getIDToken();
      accessToken = liff.getAccessToken();
      
      try { profile = await liff.getProfile(); } catch (e) { profile = null; }
      
      setStatus("初期化OK（access_token取得済み）", true);
      setDetail(profile ? `ログイン：${profile.displayName}` : "ログイン：取得中");
      enableButtons(true);


      // 任意：起動直後に自動で whoami
      // await whoami();

    } catch (err) {
      setStatus("初期化エラー", false);
      setDetail(String(err && err.message ? err.message : err));
      setOutput({ error: "liff_init_failed", detail: String(err) });
      enableButtons(false);
    }
  }

  // ===== GAS 呼び出し（GETしてJSON期待）=====
  async function fetchJson(url) {
    const res = await fetch(url, { method: "GET", cache: "no-store" });
    const text = await res.text();
    try { return JSON.parse(text); }
    catch (_) { return { error: "non_json_response", httpStatus: res.status, body: text }; }
  }

  // ===== whoami =====
  async function whoami() {
  if (!accessToken) {
    setStatus("access_token がありません（初期化未完了）", false);
    return;
  }

  const gasUrl = $("gasUrl").value.trim();
  const url =
    `${gasUrl}?action=api&op=whoami&access_token=${encodeURIComponent(accessToken)}`;

  setStatus("whoami 実行中…");

  const json = await fetchJson(url);
  setOutput(json);

  if (json.ok && json.userId) {
    setStatus("whoami OK（userId取得）", true);
    setDetail(`userId: ${json.userId}`);
  } else {
    setStatus("whoami NG", false);
    setDetail(JSON.stringify(json));
  }
}

  // ===== プロフィール表示 =====
  async function showProfile() {
    try {
      if (!profile) profile = await liff.getProfile();
      setOutput({ profile });
    } catch (e) {
      setOutput({ error: "getProfile_failed", detail: String(e) });
    }
  }

  // ===== 閉じる =====
  function closeLiff() {
    try {
      if (liff.isInClient()) liff.closeWindow();
      else setStatus("LINEアプリ内で開いている時だけ「閉じる」が効きます", false);
    } catch (e) {
      setOutput({ error: "close_failed", detail: String(e) });
    }
  }

  // ===== デバッグ情報コピー =====
  async function copyDebug() {
    const info = {
      gasUrl: $("gasUrl").value.trim(),
      liffId: $("liffId").value.trim(),
      isInClient: (typeof liff !== "undefined" && liff.isInClient) ? liff.isInClient() : null,
      isLoggedIn: (typeof liff !== "undefined" && liff.isLoggedIn) ? liff.isLoggedIn() : null,
      hasIdToken: !!idToken,
      displayName: profile ? profile.displayName : null
    };
    try {
      await navigator.clipboard.writeText(JSON.stringify(info, null, 2));
      setStatus("デバッグ情報をコピーしました", true);
      setDetail("");
    } catch (e) {
      setStatus("コピーできませんでした（ブラウザ制限の可能性）", false);
      setDetail("");
      setOutput(info);
    }
  }

  window.addEventListener("load", init);
</script>

</body>
</html>
