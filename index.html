<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>家計簿 MiniApp</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif; margin: 16px; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .card { border:1px solid #e5e5e5; border-radius:12px; padding:12px; margin:12px 0; }
    label { font-size:12px; color:#666; display:block; margin-bottom:6px; }
    input, select, button, textarea {
      font-size:14px; padding:10px; border:1px solid #ddd; border-radius:10px;
    }
    button { background:#111; color:#fff; border:none; cursor:pointer; }
    button.secondary { background:#444; }
    button.ghost { background:#fff; color:#111; border:1px solid #ddd; }
    .status { font-size:13px; color:#333; background:#f7f7f7; padding:10px; border-radius:10px; }
    .ok { color: #0a7a2f; }
    .ng { color: #b00020; }
    table { border-collapse:collapse; width:100%; }
    th, td { border-bottom:1px solid #eee; padding:8px; font-size:13px; text-align:left; }
    th { color:#666; font-weight:600; }
    .right { text-align:right; }
    img { max-width:100%; border-radius:12px; border:1px solid #eee; }
    .small { font-size:12px; color:#666; }
  </style>
</head>
<body>
  <h2>家計簿 MiniApp</h2>

  <div class="card">
    <div class="status" id="status">起動中…</div>
    <div class="small" id="who"></div>
  </div>

  <div class="card">
    <h3>追加</h3>
    <div class="row">
      <div style="flex:1; min-width:220px;">
        <label>月（YYYYMM）空なら今月</label>
        <input id="inpMonth" placeholder="例: 202601" />
      </div>
      <div style="flex:1; min-width:220px;">
        <label>項目</label>
        <select id="selItem"></select>
      </div>
    </div>

    <div class="row">
      <div style="flex:1; min-width:220px;">
        <label>金額</label>
        <input id="inpAmount" inputmode="numeric" placeholder="例: 1200" />
      </div>
      <div style="flex:1; min-width:220px;">
        <label>備考1（ドロップダウン）</label>
        <select id="selMemo1"></select>
      </div>
    </div>

    <div class="row">
      <div style="flex:1; min-width:220px;">
        <label>備考2（自由）</label>
        <input id="inpMemo2" placeholder="例: スーパー / ランチ など" />
      </div>
    </div>

    <div class="row" style="margin-top:10px;">
      <button id="btnAdd">追加</button>
      <button class="secondary" id="btnUndo">直前取り消し</button>
    </div>
  </div>

  <div class="card">
    <h3>合計（summary）</h3>
    <div class="row">
      <div style="flex:1; min-width:220px;">
        <label>月（YYYYMM）</label>
        <input id="inpSumMonth" placeholder="例: 202601" />
      </div>
      <button id="btnSummary">表示</button>
    </div>
    <div id="sumOut" style="margin-top:10px;"></div>
  </div>

  <div class="card">
    <h3>内訳（breakdown）</h3>
    <div class="row">
      <div style="flex:1; min-width:220px;">
        <label>月（YYYYMM）</label>
        <input id="inpBrMonth" placeholder="例: 202601" />
      </div>
      <button id="btnBreakdown">表示</button>
      <button class="ghost" id="btnMore" style="display:none;">もっと見る</button>
    </div>
    <div id="brOut" style="margin-top:10px;"></div>
  </div>

  <div class="card">
    <h3>グラフ（全体残額）</h3>
    <div class="row">
      <div style="flex:1; min-width:220px;">
        <label>月（YYYYMM）</label>
        <input id="inpChartMonth" placeholder="例: 202601" />
      </div>
      <button id="btnChart">更新</button>
    </div>
    <div class="small" id="chartMsg" style="margin-top:8px;"></div>
    <div id="chartImgWrap" style="margin-top:10px; display:none;">
      <img id="chartImg" alt="chart" />
    </div>
  </div>

<script>
/*** ★★★ あなたが設定する2つ ★★★ ***/
const LIFF_ID = "2008812269-var864Dv";
const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbwCRPyhJLCWkw_F-pm177DGUgq2R_sTVPZLzXuotaJZ6B6R53vDBVpuKXUfYb_N6P_2Eg/exec"; // 末尾 /exec のURL

let accessToken = "";
let userId = "";
let breakdownStart = 0;
const breakdownLimit = 50;

// DOM helper
const el = (id)=>document.getElementById(id);

function setStatus(msg, ok=true){
  const s = el("status");
  s.textContent = msg;
  s.className = "status " + (ok ? "ok" : "ng");
}

// yyyyMM（今月）
function currentYm(){
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,'0');
  return `${y}${m}`;
}

async function liffInit(){
  setStatus("LIFF 初期化中…");
  await liff.init({ liffId: LIFF_ID });

  if (!liff.isLoggedIn()){
    setStatus("ログイン中…");
    liff.login();
    return;
  }

  accessToken = liff.getAccessToken();
  setStatus("ログイン完了。ユーザー確認中…");

  const who = await apiGet("whoami");
  userId = who.userId;
  el("who").textContent = `userId: ${userId}`;

  // items & memo1 options
  const items = await apiGet("items");
  fillSelect(el("selItem"), items.items);
  fillSelect(el("selMemo1"), items.memo1Options || ["", "かずき","かずきカード","みく","みくカード"]);

  // 初期値
  el("inpSumMonth").value = currentYm();
  el("inpBrMonth").value = currentYm();
  el("inpChartMonth").value = currentYm();

  setStatus("準備OK（追加・合計・内訳・グラフが使えます）");
}

function fillSelect(selectEl, arr){
  selectEl.innerHTML = "";
  arr.forEach(v=>{
    const opt = document.createElement("option");
    opt.value = v;
    opt.textContent = v === "" ? "（なし）" : v;
    selectEl.appendChild(opt);
  });
}

// GET API
async function apiGet(op, params={}){
  const url = new URL(WEBAPP_URL);
  url.searchParams.set("action","api");
  url.searchParams.set("op", op);

  // chart_image_b64 は token不要（GAS側と合わせてる）
  if (op !== "chart_image_b64"){
    url.searchParams.set("access_token", accessToken);
  }

  Object.entries(params).forEach(([k,v])=>{
    if (v !== undefined && v !== null && String(v).length) url.searchParams.set(k, String(v));
  });

  const res = await fetch(url.toString(), { method:"GET" });
  const data = await res.json();
  if (!data.ok) throw new Error(data.error || "API error");
  return data;
}

// POST API
async function apiPost(body){
  const url = new URL(WEBAPP_URL);
  url.searchParams.set("action","api");

  const res = await fetch(url.toString(), {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(body)
  });

  const data = await res.json();
  if (!data.ok) throw new Error(data.error || "API error");
  return data;
}

function parseAmountInput(v){
  const t = String(v||"").trim().replace(/,/g,"");
  if (!t || !/^-?\d+$/.test(t)) return NaN;
  return Number(t);
}

async function onAdd(){
  try{
    setStatus("追加中…");
    const month = (el("inpMonth").value || "").trim();
    const item = el("selItem").value;
    const amount = parseAmountInput(el("inpAmount").value);
    const memo1 = el("selMemo1").value;
    const memo2 = (el("inpMemo2").value || "").trim();

    if (!item) throw new Error("項目を選んでください");
    if (!Number.isFinite(amount)) throw new Error("金額が不正です");

    const body = {
      op: "add",
      access_token: accessToken,
      item, amount, memo1, memo2
    };
    if (month) body.month = month;

    const r = await apiPost(body);
    setStatus("✅ 追加しました");
    // 入力欄リセット（好みで）
    el("inpAmount").value = "";
    el("inpMemo2").value = "";

  }catch(e){
    setStatus("❌ 追加失敗: " + e.message, false);
  }
}

async function onUndo(){
  try{
    setStatus("取り消し中…");
    const r = await apiPost({ op:"undo", access_token: accessToken });
    if (r.ok){
      setStatus("✅ " + r.msg);
    }else{
      setStatus("❌ " + (r.msg || "取り消し失敗"), false);
    }
  }catch(e){
    setStatus("❌ 取り消し失敗: " + e.message, false);
  }
}

function renderSummary(data){
  const overall = Number(data.overall||0).toLocaleString();
  const rows = data.rows || [];
  let html = `<div><b>全体残額：</b>${overall}円</div>`;
  html += `<table style="margin-top:8px;">
    <thead><tr><th>項目</th><th class="right">予算</th><th class="right">支出</th><th class="right">残額</th></tr></thead><tbody>`;
  rows.forEach(r=>{
    html += `<tr>
      <td>${escapeHtml(r.name)}</td>
      <td class="right">${Number(r.budget||0).toLocaleString()}</td>
      <td class="right">${Number(r.spend||0).toLocaleString()}</td>
      <td class="right">${Number(r.remain||0).toLocaleString()}</td>
    </tr>`;
  });
  html += `</tbody></table>`;
  el("sumOut").innerHTML = html;
}

function renderBreakdown(data){
  const rows = data.rows || [];
  let html = `<div class="small">表示：${data.start+1}〜${Math.min(data.start+rows.length, data.total)} / ${data.total}</div>`;
  html += `<table style="margin-top:8px;">
    <thead><tr><th>日付</th><th>項目</th><th class="right">金額</th><th>備考1</th><th>備考2</th></tr></thead><tbody>`;
  rows.forEach(r=>{
    html += `<tr>
      <td>${escapeHtml(r.date)}</td>
      <td>${escapeHtml(r.item)}</td>
      <td class="right">${Number(r.amount||0).toLocaleString()}</td>
      <td>${escapeHtml(r.memo1||"")}</td>
      <td>${escapeHtml(r.memo2||"")}</td>
    </tr>`;
  });
  html += `</tbody></table>`;
  el("brOut").innerHTML = html;

  // more
  if (data.hasMore){
    el("btnMore").style.display = "";
  } else {
    el("btnMore").style.display = "none";
  }
}

async function onSummary(){
  try{
    setStatus("合計を取得中…");
    const month = (el("inpSumMonth").value || "").trim() || currentYm();
    const r = await apiGet("summary", { month });
    renderSummary(r);
    setStatus("✅ 合計を表示しました");
  }catch(e){
    setStatus("❌ 合計取得失敗: " + e.message, false);
  }
}

async function onBreakdown(reset=true){
  try{
    setStatus("内訳を取得中…");
    const month = (el("inpBrMonth").value || "").trim() || currentYm();
    if (reset) breakdownStart = 0;

    const r = await apiGet("breakdown", { month, start: breakdownStart, limit: breakdownLimit });
    renderBreakdown(r);

    breakdownStart = r.nextStart || (breakdownStart + breakdownLimit);
    setStatus("✅ 内訳を表示しました");
  }catch(e){
    setStatus("❌ 内訳取得失敗: " + e.message, false);
  }
}

async function loadChart(){
  try{
    const month = (el("inpChartMonth").value || "").trim() || currentYm();
    el("chartMsg").textContent = "グラフ生成中…";
    el("chartImgWrap").style.display = "none";

    // 1) グラフ生成（Driveに保存してfileIdを返す）
    const r = await apiGet("chart_overall", { month });

    // 2) fileId → base64
    el("chartMsg").textContent = "画像を取得中…";
    const b = await apiGet("chart_image_b64", { fileId: r.fileId });

    // 3) data URI表示
    const img = el("chartImg");
    img.onload = ()=>{
      el("chartImgWrap").style.display = "";
      el("chartMsg").textContent = "✅ グラフを更新しました";
    };
    img.onerror = ()=>{
      el("chartMsg").textContent = "❌ 画像は読み込めませんでした";
    };
    img.src = "data:image/jpeg;base64," + b.b64;

  }catch(e){
    el("chartMsg").textContent = "❌ グラフ更新失敗: " + e.message;
  }
}

function escapeHtml(s){
  return String(s||"").replace(/[&<>"']/g, (c)=>({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[c]));
}

// events
el("btnAdd").addEventListener("click", onAdd);
el("btnUndo").addEventListener("click", onUndo);
el("btnSummary").addEventListener("click", onSummary);
el("btnBreakdown").addEventListener("click", ()=>onBreakdown(true));
el("btnMore").addEventListener("click", ()=>onBreakdown(false));
el("btnChart").addEventListener("click", loadChart);

// start
liffInit().catch(e=>{
  setStatus("❌ 起動失敗: " + e.message, false);
});
</script>
</body>
</html>
