<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>家計簿 MiniApp</title>
  <style>
    :root{
      --bg:#f6f7fb; --card:#fff; --text:#111; --muted:#666;
      --primary:#06c755; --danger:#e53935; --border:#e7e7ee;
      --shadow:0 10px 30px rgba(20,20,40,.08);
      --r:16px;
    }
    body{ margin:0; background:var(--bg); color:var(--text); font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif; }
    header{ position:sticky; top:0; z-index:10; background:rgba(246,247,251,.92); backdrop-filter: blur(6px); border-bottom:1px solid var(--border); }
    .wrap{ max-width:980px; margin:0 auto; padding:16px; }
    .row{ display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    .grow{ flex:1 1 auto; }
    .card{ background:var(--card); border:1px solid var(--border); border-radius:var(--r); box-shadow:var(--shadow); padding:14px; }
    h1{ font-size:18px; margin:0 0 10px; }
    h3{ font-size:14px; margin:0 0 8px; }
    .muted{ color:var(--muted); font-size:12px; }
    .pill{ display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border-radius:999px; border:1px solid var(--border); background:#fff; }
    select,input,button,textarea{
      font:inherit; border-radius:12px; border:1px solid var(--border); padding:10px 12px; background:#fff;
    }
    button{ cursor:pointer; border:none; }
    .btn{ background:var(--primary); color:#fff; font-weight:700; padding:10px 14px; border-radius:12px; }
    .btn-sub{ background:#fff; border:1px solid var(--border); }
    .btn-danger{ background:var(--danger); color:#fff; font-weight:700; }
    .grid{ display:grid; gap:12px; grid-template-columns: 1fr; }
    @media(min-width:900px){ .grid{ grid-template-columns: 420px 1fr; } }

    .tabs{ display:flex; gap:8px; flex-wrap:wrap; }
    .tab{ padding:9px 12px; border-radius:999px; border:1px solid var(--border); background:#fff; cursor:pointer; font-weight:700; }
    .tab.active{ background:var(--primary); color:#fff; border-color:transparent; }
    .section{ display:none; }
    .section.active{ display:block; }

    table{ width:100%; border-collapse:separate; border-spacing:0; overflow:hidden; border-radius:12px; border:1px solid var(--border); background:#fff; }
    th,td{ padding:10px 10px; border-bottom:1px solid var(--border); font-size:13px; }
    th{ background:#f2f3f8; text-align:left; font-size:12px; color:#333; }
    tr:last-child td{ border-bottom:none; }
    td.r{ text-align:right; white-space:nowrap; }
    .neg{ color:var(--danger); font-weight:800; }
    .chart-img{ width:100%; border-radius:12px; border:1px solid var(--border); margin-top:8px; background:#fff; }
    .err{ color:var(--danger); font-weight:700; }
    .ok{ color:#0a7; font-weight:700; }
    .split{ display:flex; gap:10px; flex-wrap:wrap; }
    .split > *{ flex:1 1 160px; }
    .small{ font-size:12px; }
    .loader{ display:none; }
    .loader.on{ display:inline-block; }
    .kpi{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .kpi .box{ padding:10px 12px; border-radius:12px; background:#fff; border:1px solid var(--border); }
    .kpi .v{ font-weight:900; font-size:16px; }
  </style>
  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
<header>
  <div class="wrap">
    <div class="row">
      <div class="grow">
        <h1>家計簿 MiniApp</h1>
        <div class="muted" id="statusLine">初期化中…</div>
      </div>

      <div class="pill">
        <span class="muted">月</span>
        <select id="monthSel"></select>
      </div>

      <button class="btn-sub" id="btnRefresh">更新</button>
      <span class="loader" id="loader">⏳</span>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="grid">
    <!-- 左：入力 -->
    <section class="card">
      <h3>入力</h3>
      <div class="muted">Botと同じ2人限定。ここで追加/取り消しできます。</div>

      <div style="height:10px"></div>

      <div class="split">
        <select id="itemSel"></select>
        <input id="amountInp" inputmode="numeric" placeholder="金額（例：1200）" />
      </div>

      <div style="height:10px"></div>

      <div class="split">
        <input id="memo1Inp" placeholder="備考1（例：かずき/みく/カード）" />
        <input id="memo2Inp" placeholder="備考2（任意）" />
      </div>

      <div style="height:12px"></div>

      <div class="row">
        <button class="btn" id="btnAdd">追加</button>
        <button class="btn-danger" id="btnUndo">直前取り消し</button>
      </div>

      <div style="height:10px"></div>
      <div class="small" id="actionMsg"></div>

      <div style="height:14px"></div>
      <div class="muted small">
        ※ 金額は全角・カンマ入りでもOK（GAS側で吸収）<br/>
        ※ 追加後は「サマリ・内訳・グラフ」全部を自動更新します
      </div>
    </section>

    <!-- 右：表示 -->
    <section class="card">
      <div class="tabs">
        <div class="tab active" data-tab="tabSummary">合計</div>
        <div class="tab" data-tab="tabBreakdown">内訳</div>
        <div class="tab" data-tab="tabChart">グラフ</div>
      </div>

      <div style="height:12px"></div>

      <!-- 合計 -->
      <div class="section active" id="tabSummary">
        <h3>合計（項目別）</h3>
        <div class="kpi">
          <div class="box">
            <div class="muted small">全体残額</div>
            <div class="v" id="overallMoney">-</div>
          </div>
          <div class="box">
            <div class="muted small">表示月</div>
            <div class="v" id="kpiMonth">-</div>
          </div>
        </div>
        <div style="height:10px"></div>
        <div id="summaryBox"></div>
      </div>

      <!-- 内訳 -->
      <div class="section" id="tabBreakdown">
        <h3>内訳（最新50件）</h3>
        <div class="muted small" id="breakMeta">-</div>
        <div style="height:10px"></div>
        <div id="breakdownBox"></div>
        <div style="height:10px"></div>
        <button class="btn-sub" id="btnMore">もっと見る</button>
      </div>

      <!-- グラフ -->
      <div class="section" id="tabChart">
        <h3>今月の残額グラフ</h3>
        <div class="muted small" id="chartHint">読み込み中…</div>
        <img id="chartImg" class="chart-img" />
      </div>
    </section>
  </div>
</main>

<script>
  // ========= 設定（要差し替え） =========
  const LIFF_ID = "2008812269-var864Dv";
  const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbwCRPyhJLCWkw_F-pm177DGUgq2R_sTVPZLzXuotaJZ6B6R53vDBVpuKXUfYb_N6P_2Eg/exec"; // 例: https://script.google.com/macros/s/.../exec

  // ========= 状態 =========
  let accessToken = "";
  let userId = "";
  let selectedMonth = "";  // YYYYMM
  let breakdownStart = 0;
  const breakdownLimit = 50;

  // ========= DOM =========
  const $ = (id) => document.getElementById(id);
  const statusLine = $("statusLine");
  const loader = $("loader");
  const monthSel = $("monthSel");
  const itemSel = $("itemSel");
  const amountInp = $("amountInp");
  const memo1Inp = $("memo1Inp");
  const memo2Inp = $("memo2Inp");
  const actionMsg = $("actionMsg");

  const overallMoneyEl = $("overallMoney");
  const kpiMonthEl = $("kpiMonth");
  const summaryBox = $("summaryBox");

  const breakdownBox = $("breakdownBox");
  const breakMeta = $("breakMeta");
  const btnMore = $("btnMore");

  const chartHint = $("chartHint");
  const chartImg = $("chartImg");

  // ========= util =========
  function setLoading(on){
    loader.classList.toggle("on", !!on);
  }

  function fmtYen(n){
    const x = Number(n || 0);
    return x.toLocaleString("ja-JP") + "円";
  }

  function yyyymmLabel(ym){
    return ym.slice(0,4) + "/" + ym.slice(4,6);
  }

  function apiUrl(op, params={}){
    const u = new URL(WEBAPP_URL);
    u.searchParams.set("action", "api");
    u.searchParams.set("op", op);
    u.searchParams.set("access_token", accessToken);
    Object.entries(params).forEach(([k,v]) => u.searchParams.set(k, v));
    return u.toString();
  }

  async function getJson(url){
    const res = await fetch(url, { method:"GET" });
    const txt = await res.text();
    try { return JSON.parse(txt); }
    catch(e){ return { ok:false, error:"non_json_response", raw:txt }; }
  }

  async function postJson(bodyObj){
    const res = await fetch(WEBAPP_URL + "?action=api", {
      method:"POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify(bodyObj)
    });
    const txt = await res.text();
    try { return JSON.parse(txt); }
    catch(e){ return { ok:false, error:"non_json_response", raw:txt }; }
  }

  function setMsg(text, ok=true){
    actionMsg.className = ok ? "ok" : "err";
    actionMsg.textContent = text;
  }

  function setStatus(text, ok=true){
    statusLine.className = ok ? "" : "err";
    statusLine.textContent = text;
  }

  // ========= Tabs =========
  document.querySelectorAll(".tab").forEach(t => {
    t.addEventListener("click", () => {
      document.querySelectorAll(".tab").forEach(x => x.classList.remove("active"));
      document.querySelectorAll(".section").forEach(x => x.classList.remove("active"));
      t.classList.add("active");
      const id = t.dataset.tab;
      document.getElementById(id).classList.add("active");
    });
  });

  // ========= 初期化 =========
  async function init(){
    try{
      setLoading(true);
      setStatus("LIFF初期化中…");

      await liff.init({ liffId: LIFF_ID });

      if (!liff.isLoggedIn()){
        liff.login();
        return;
      }

      accessToken = liff.getAccessToken();
      if(!accessToken){
        setStatus("access_token が取得できませんでした", false);
        return;
      }

      // whoami
      const who = await getJson(apiUrl("whoami"));
      if(!who.ok){
        setStatus("whoami失敗: " + (who.error||"unknown"), false);
        return;
      }
      userId = who.userId;
      setStatus("ログインOK: " + userId);

      // month select
      setupMonthSelect();

      // items
      const it = await getJson(apiUrl("items"));
      if(!it.ok){
        setStatus("items取得失敗: " + (it.error||"unknown"), false);
        return;
      }
      setupItemSelect(it.items || []);

      // first load
      await refreshAll(true);

      // events
      $("btnRefresh").addEventListener("click", async () => refreshAll(true));
      monthSel.addEventListener("change", async () => {
        selectedMonth = monthSel.value;
        breakdownStart = 0;
        await refreshAll(true);
      });

      $("btnAdd").addEventListener("click", onAdd);
      $("btnUndo").addEventListener("click", onUndo);
      btnMore.addEventListener("click", onMore);

    }catch(e){
      setStatus("初期化エラー: " + (e.message||e), false);
    }finally{
      setLoading(false);
    }
  }

  function setupMonthSelect(){
    // 直近12ヶ月
    const now = new Date();
    const list = [];
    for(let i=0;i<12;i++){
      const d = new Date(now.getFullYear(), now.getMonth()-i, 1);
      const ym = d.getFullYear().toString() + String(d.getMonth()+1).padStart(2,"0");
      list.push(ym);
    }
    monthSel.innerHTML = "";
    list.forEach(ym => {
      const opt = document.createElement("option");
      opt.value = ym;
      opt.textContent = yyyymmLabel(ym);
      monthSel.appendChild(opt);
    });
    selectedMonth = list[0];
    monthSel.value = selectedMonth;
  }

  function setupItemSelect(items){
    itemSel.innerHTML = "";
    items.forEach(name => {
      const opt = document.createElement("option");
      opt.value = name;
      opt.textContent = name;
      itemSel.appendChild(opt);
    });
  }

  // ========= API load =========
  async function refreshAll(resetBreakdown){
    try{
      setLoading(true);
      setMsg("", true);

      $("kpiMonth").textContent = yyyymmLabel(selectedMonth);

      await loadSummary();
      if(resetBreakdown) breakdownStart = 0;
      await loadBreakdown(true);
      await loadChartOverall();

    }catch(e){
      setMsg("更新エラー: " + (e.message||e), false);
    }finally{
      setLoading(false);
    }
  }

  async function loadSummary(){
    const r = await getJson(apiUrl("summary", { month: selectedMonth }));
    if(!r.ok){
      summaryBox.innerHTML = `<div class="err">summary取得失敗: ${escapeHtml(r.error||"unknown")}</div>`;
      overallMoneyEl.textContent = "-";
      return;
    }
    overallMoneyEl.textContent = fmtYen(r.overall || 0);
    kpiMonthEl.textContent = yyyymmLabel(r.month || selectedMonth);

    const rows = r.rows || [];
    const html = [];
    html.push(`<table><thead><tr>
      <th>項目</th><th class="r">予算</th><th class="r">支出</th><th class="r">残額</th>
    </tr></thead><tbody>`);

    rows.forEach(x => {
      const neg = Number(x.remain||0) < 0;
      html.push(`<tr>
        <td>${escapeHtml(x.name)}</td>
        <td class="r">${fmtYen(x.budget||0)}</td>
        <td class="r">${fmtYen(x.spend||0)}</td>
        <td class="r ${neg ? "neg":""}">${fmtYen(x.remain||0)}</td>
      </tr>`);
    });

    html.push(`</tbody></table>`);
    summaryBox.innerHTML = html.join("");
  }

  async function loadBreakdown(reset){
    const r = await getJson(apiUrl("breakdown", {
      month: selectedMonth,
      start: breakdownStart,
      limit: breakdownLimit
    }));
    if(!r.ok){
      breakdownBox.innerHTML = `<div class="err">breakdown取得失敗: ${escapeHtml(r.error||"unknown")}</div>`;
      breakMeta.textContent = "-";
      btnMore.style.display = "none";
      return;
    }

    breakMeta.textContent = `表示範囲：${r.start+1}–${Math.min(r.start+r.rows.length, r.total)} / ${r.total}`;
    btnMore.style.display = r.hasMore ? "inline-block" : "none";

    const rows = r.rows || [];
    const html = [];
    html.push(`<table><thead><tr>
      <th>日付</th><th>項目</th><th class="r">金額</th><th>備考</th>
    </tr></thead><tbody>`);

    rows.forEach(x => {
      html.push(`<tr>
        <td>${escapeHtml(String(x.date||""))}</td>
        <td>${escapeHtml(String(x.item||""))}</td>
        <td class="r">${fmtYen(x.amount||0)}</td>
        <td>${escapeHtml([x.memo1,x.memo2].filter(Boolean).join(" / ") || "-")}</td>
      </tr>`);
    });

    html.push(`</tbody></table>`);

    if(reset) breakdownBox.innerHTML = html.join("");
    else breakdownBox.insertAdjacentHTML("beforeend", html.join(""));

    breakdownStart = r.nextStart || (breakdownStart + rows.length);
  }

  async function loadChartOverall(){
    chartHint.textContent = "読み込み中…";
    chartImg.style.display = "none";

    const r = await getJson(apiUrl("chart_overall", { month: selectedMonth }));
    if(!r.ok || !r.url){
      chartHint.textContent = "グラフ取得失敗";
      return;
    }

    chartImg.onload = () => {
      chartHint.textContent = "";
      chartImg.style.display = "block";
    };
    chartImg.onerror = () => {
      chartHint.textContent = "画像読み込み失敗";
      chartImg.style.display = "none";
    };

    // ブラウザキャッシュ完全回避
    chartImg.src = r.url + "&t=" + Date.now();
  }

  // ========= actions =========
  async function onAdd(){
    const item = itemSel.value;
    const amtRaw = amountInp.value.trim();
    if(!amtRaw){
      setMsg("金額を入力してください", false);
      return;
    }

    const body = {
      op: "add",
      access_token: accessToken,
      item: item,
      amount: amtRaw,        // GAS側parseAmountで吸収してるなら文字でもOK
      memo1: memo1Inp.value.trim(),
      memo2: memo2Inp.value.trim(),
      month: selectedMonth
    };

    setLoading(true);
    const r = await postJson(body);
    setLoading(false);

    if(!r.ok){
      setMsg("追加失敗: " + (r.error||"unknown"), false);
      return;
    }

    setMsg("追加しました");
    amountInp.value = "";
    memo1Inp.value = "";
    memo2Inp.value = "";

    // 追加後は全部更新
    breakdownStart = 0;
    await refreshAll(true);
  }

  async function onUndo(){
    setLoading(true);
    const r = await postJson({ op:"undo", access_token: accessToken });
    setLoading(false);

    if(!r.ok){
      setMsg("取り消し失敗: " + (r.msg || r.error || "unknown"), false);
      return;
    }

    setMsg(r.msg || "取り消しました");
    breakdownStart = 0;
    await refreshAll(true);
  }

  async function onMore(){
    await loadBreakdown(false);
  }

  // ========= helpers =========
  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, c => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[c]));
  }

  // start
  init();
</script>
</body>
</html>
