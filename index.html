<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>家計簿</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    :root{
      --bg:#0b0c10; --card:#12141a; --muted:#9aa3b2; --text:#eef2ff;
      --line:#232735; --accent:#4f7cff; --danger:#ff5a7a; --ok:#3ddc97;
    }
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"Hiragino Kaku Gothic ProN","Noto Sans JP",sans-serif;
      background:var(--bg); color:var(--text);
    }
    header{
      padding:16px 16px 10px; position:sticky; top:0;
      background:linear-gradient(180deg, rgba(11,12,16,.98), rgba(11,12,16,.85));
      backdrop-filter: blur(10px); border-bottom:1px solid var(--line); z-index:10;
    }
    .headrow{ display:flex; align-items:flex-start; justify-content:space-between; gap:10px; }
    h1{ margin:0; font-size:18px; letter-spacing:.02em; }
    .sub{ margin-top:6px; font-size:12px; color:var(--muted); }
    .pillrow{ display:flex; gap:8px; align-items:center; justify-content:flex-end; flex-wrap:wrap; }
    .pill{
      font-size:12px; padding:6px 10px; border-radius:999px;
      border:1px solid var(--line); background:rgba(18,20,26,.7);
      color:var(--text); white-space:nowrap;
    }
    .pill.ok{ border-color:#2c3350; }
    .pill.good{ border-color:rgba(61,220,151,.35); }
    .pill.bad{ border-color:rgba(255,90,122,.35); }
    .pill.muted{ color:var(--muted); }

    .wrap{ padding:14px 14px 60px; max-width:860px; margin:0 auto; }
    .tabs{ display:flex; gap:8px; margin:10px 0 14px; }
    .tab{
      flex:1; background:transparent; border:1px solid var(--line); color:var(--text);
      padding:10px 8px; border-radius:12px; font-weight:700;
    }
    .tab.active{ background:var(--card); border-color:#2c3350; }
    .card{ background:var(--card); border:1px solid var(--line); border-radius:16px; padding:14px; margin:12px 0; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end; }
    label{ font-size:12px; color:var(--muted); display:block; margin-bottom:6px; }
    select,input,textarea{
      width:100%; box-sizing:border-box;
      background:#0f1117; border:1px solid #2a2f40; color:var(--text);
      border-radius:12px; padding:10px 12px; font-size:14px; outline:none;
    }
    textarea{ min-height:70px; }

    .btn{
      background:var(--accent); border:none; color:white;
      padding:11px 14px; border-radius:12px; font-weight:800;
      cursor:pointer;
    }
    .btn.sub{ background:transparent; border:1px solid var(--line); color:var(--text); }
    .btn.danger{ background:transparent; border:1px solid rgba(255,90,122,.5); color:#ff90a7; }
    .btn:disabled{ opacity:.45; cursor:not-allowed; }

    .hint{ font-size:12px; color:var(--muted); margin-top:8px; line-height:1.5; }
    table{ width:100%; border-collapse:collapse; font-size:13px; }
    th,td{ border-bottom:1px solid var(--line); padding:10px 6px; text-align:left; vertical-align:top; }
    th{ color:var(--muted); font-weight:800; font-size:12px; }
    td.num{ text-align:right; white-space:nowrap; }
    .kpi{ display:flex; justify-content:space-between; align-items:baseline; gap:8px; }
    .kpi b{ font-size:22px; }
    .kpi span{ color:var(--muted); font-size:12px; }

    .msg{
      white-space:pre-wrap; font-size:12px; color:#cbd5ff;
      margin-top:10px; padding:10px; border:1px dashed #2a2f40;
      border-radius:12px; background:#0f1117;
    }

    /* chart list */
    .chartToolbar{
      display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:space-between;
      margin-top:10px;
    }
    .chartToolbar .left{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .tiny{
      font-size:12px; color:var(--muted);
      border:1px solid var(--line); border-radius:999px; padding:6px 10px;
      background:rgba(18,20,26,.55);
    }
    .progressBar{
      width:100%; height:10px; border-radius:999px;
      border:1px solid var(--line); background:#0f1117;
      overflow:hidden;
    }
    .progressBar > div{
      height:100%; width:0%;
      background:linear-gradient(90deg, rgba(79,124,255,.2), rgba(79,124,255,.8));
      transition:width .2s ease;
    }

    .chartList{ display:flex; flex-direction:column; gap:12px; }
    .chartItemTitle{ font-size:13px; font-weight:900; color:#dbe4ff; margin-bottom:8px; }
    .chartImg{
      width:100%; border-radius:14px; border:1px solid var(--line);
      background:#0f1117; cursor:pointer;
    }
    .chartSkeleton{
      border-radius:14px; border:1px solid var(--line);
      height:220px; background:linear-gradient(90deg, rgba(255,255,255,.03), rgba(255,255,255,.08), rgba(255,255,255,.03));
      animation: shimmer 1.2s infinite linear;
    }
    @keyframes shimmer{
      0%{ background-position: 0 0; }
      100%{ background-position: 600px 0; }
    }

    /* modal */
    .modalBackdrop{
      position:fixed; inset:0; background:rgba(0,0,0,.75);
      display:none; align-items:center; justify-content:center; z-index:999;
      padding:16px;
    }
    .modalBackdrop.show{ display:flex; }
    .modalCard{
      width:min(980px, 100%); background:#0f1117; border:1px solid #2a2f40;
      border-radius:16px; padding:10px;
    }
    .modalTop{ display:flex; justify-content:space-between; align-items:center; gap:8px; margin-bottom:8px; }
    .modalTop .title{ font-weight:900; font-size:14px; color:#eef2ff; }
    .modalTop button{
      background:transparent; border:1px solid var(--line); color:var(--text);
      padding:6px 10px; border-radius:10px; font-weight:800;
      cursor:pointer;
    }
    .modalImg{ width:100%; border-radius:12px; border:1px solid var(--line); background:#0b0c10; }
  </style>
</head>

<body>
<header>
  <div class="headrow">
    <div>
      <h1>家計簿</h1>
      <div class="sub" id="who">initializing…</div>
    </div>
    <div class="pillrow">
      <div class="pill ok" id="loginPill">未ログイン</div>
      <div class="pill muted" id="statePill">待機</div>
    </div>
  </div>
</header>

<div class="wrap">
  <div class="tabs">
    <button class="tab active" data-tab="add">追加</button>
    <button class="tab" data-tab="summary">合計</button>
    <button class="tab" data-tab="breakdown">内訳</button>
    <button class="tab" data-tab="chart">グラフ</button>
  </div>

  <!-- 追加 -->
  <section id="tab-add">
    <div class="card">
      <div class="row">
        <div style="flex:1; min-width:220px;">
          <label>月（YYYYMM）</label>
          <input id="monthAdd" placeholder="例: 202601" />
          <div class="hint">空欄なら当月。</div>
        </div>
        <div style="flex:2; min-width:260px;">
          <label>項目</label>
          <select id="itemSel"></select>
        </div>
      </div>

      <div class="row">
        <div style="flex:1; min-width:180px;">
          <label>金額</label>
          <input id="amount" inputmode="numeric" placeholder="例: 1200" />
        </div>
        <div style="flex:1; min-width:180px;">
          <label>備考1</label>
          <select id="memo1Sel"></select>
        </div>
      </div>

      <div class="row">
        <div style="flex:1; min-width:280px;">
          <label>備考2</label>
          <input id="memo2" placeholder="任意" />
        </div>
      </div>

      <div class="row" style="margin-top:8px;">
        <button class="btn" id="btnAdd">追加</button>
        <button class="btn sub" id="btnUndo">直前取り消し</button>
      </div>

      <div class="msg" id="msgAdd" style="display:none;"></div>
    </div>
  </section>

  <!-- 合計 -->
  <section id="tab-summary" style="display:none;">
    <div class="card">
      <div class="row">
        <div style="flex:1; min-width:220px;">
          <label>月（YYYYMM）</label>
          <input id="monthSum" placeholder="例: 202601" />
          <div class="hint">空欄なら当月。</div>
        </div>
        <div style="display:flex; align-items:flex-end; gap:10px;">
          <button class="btn" id="btnSum">取得</button>
        </div>
      </div>

      <div class="card" style="margin-top:12px;">
        <div class="kpi"><span>全体の残額</span><b id="overall">-</b></div>
      </div>

      <div class="card" style="margin-top:12px;">
        <table>
          <thead>
            <tr><th>項目</th><th class="num">予算</th><th class="num">支出</th><th class="num">残額</th></tr>
          </thead>
          <tbody id="sumBody"></tbody>
        </table>
      </div>

      <div class="msg" id="msgSum" style="display:none;"></div>
    </div>
  </section>

  <!-- 内訳 -->
  <section id="tab-breakdown" style="display:none;">
    <div class="card">
      <div class="row">
        <div style="flex:1; min-width:220px;">
          <label>月（YYYYMM）</label>
          <input id="monthBd" placeholder="例: 202601" />
        </div>
        <div style="flex:1; min-width:120px;">
          <label>開始</label>
          <input id="startBd" inputmode="numeric" value="0" />
        </div>
        <div style="flex:1; min-width:120px;">
          <label>件数</label>
          <input id="limitBd" inputmode="numeric" value="50" />
        </div>
        <div style="display:flex; align-items:flex-end; gap:10px;">
          <button class="btn" id="btnBd">取得</button>
          <button class="btn sub" id="btnBdMore">次へ</button>
        </div>
      </div>

      <div class="card" style="margin-top:12px;">
        <table>
          <thead>
            <tr><th>日付</th><th>項目</th><th class="num">金額</th><th>備考1</th><th>備考2</th></tr>
          </thead>
          <tbody id="bdBody"></tbody>
        </table>
        <div class="hint" id="bdInfo"></div>
      </div>

      <div class="msg" id="msgBd" style="display:none;"></div>
    </div>
  </section>

  <!-- グラフ -->
  <section id="tab-chart" style="display:none;">
    <div class="card">
      <div class="row">
        <div style="flex:1; min-width:220px;">
          <label>月（YYYYMM）</label>
          <input id="monthChart" placeholder="例: 202601" />
          <div class="hint">空欄なら当月。</div>
        </div>
        <div style="display:flex; align-items:flex-end; gap:10px;">
          <button class="btn" id="btnChartList">一覧表示</button>
          <button class="btn sub" id="btnChartStop" disabled>停止</button>
          <button class="btn sub" id="btnChartRetry" disabled>再試行</button>
        </div>
      </div>

      <div class="hint" id="chartHint">
        ※ 安定版：一覧は fileId だけ取得 → 画像は1枚ずつ base64 化して表示（Spreadsheet切断対策）
      </div>

      <div class="chartToolbar">
        <div class="left">
          <span class="tiny" id="chartStatus">未取得</span>
          <span class="tiny" id="chartCount">0 / 0</span>
        </div>
      </div>
      <div class="progressBar" style="margin-top:10px;">
        <div id="chartProg"></div>
      </div>

      <div class="card" style="margin-top:12px;">
        <div id="chartList" class="chartList"></div>
      </div>

      <div class="msg" id="msgChart" style="display:none;"></div>
    </div>
  </section>
</div>

<!-- modal -->
<div class="modalBackdrop" id="imgModal">
  <div class="modalCard">
    <div class="modalTop">
      <div class="title" id="modalTitle">画像</div>
      <button id="modalClose">閉じる</button>
    </div>
    <img id="modalImg" class="modalImg" alt="modal" />
  </div>
</div>

<script>
  // ============================
  // 設定：ここをあなたの値に変更
  // ============================
  const LIFF_ID = "2008812269-var864Dv";
  const API_BASE = "https://script.google.com/macros/s/AKfycbwCRPyhJLCWkw_F-pm177DGUgq2R_sTVPZLzXuotaJZ6B6R53vDBVpuKXUfYb_N6P_2Eg/exec"; // /exec まで

  // ===== 状態表示 =====
  function setState(text, tone="muted"){
    const el = document.getElementById("statePill");
    el.textContent = text;
    el.classList.remove("muted","good","bad","ok");
    el.classList.add(tone === "good" ? "good" : tone === "bad" ? "bad" : "muted");
  }

  // timeout付きfetch
  async function fetchWithTimeout(url, opts={}, timeoutMs=60000){
    const ac = new AbortController();
    const t = setTimeout(()=>ac.abort(), timeoutMs);
    try{
      const res = await fetch(url, {...opts, signal: ac.signal});
      return res;
    } finally {
      clearTimeout(t);
    }
  }

  async function readRes(res){
    const ct = (res.headers.get("content-type")||"").toLowerCase();
    const text = await res.text();
    if (ct.includes("application/json")) {
      try { return JSON.parse(text); } catch(e){ return { ok:false, error:"JSON parse failed", raw:text }; }
    }
    try { return JSON.parse(text); } catch(e){ return { ok:false, error:"Non-JSON response", raw:text }; }
  }

  function money(n){
    const x = Number(n||0);
    return x.toLocaleString();
  }

  function showMsg(id, obj){
    const el = document.getElementById(id);
    el.style.display = "block";
    el.textContent = typeof obj === "string" ? obj : JSON.stringify(obj, null, 2);
  }
  function hideMsg(id){
    const el = document.getElementById(id);
    el.style.display = "none";
    el.textContent = "";
  }

  function currentYYYYMM(){
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    return `${y}${m}`;
  }

  let accessToken = "";
  let myUserId = "";

  async function apiGet(op, params={}, timeoutMs=60000){
    const qs = new URLSearchParams({
      action:"api",
      op,
      access_token: accessToken,
      ...params
    });
    const url = `${API_BASE}?${qs.toString()}`;
    const res = await fetchWithTimeout(url, { method:"GET" }, timeoutMs);
    const data = await readRes(res);
    if (!res.ok || !data.ok) throw new Error(data.error || `HTTP ${res.status}`);
    return data;
  }

  async function apiPost(body, timeoutMs=60000){
    const url = `${API_BASE}?action=api`;
    const res = await fetchWithTimeout(url, {
      method:"POST",
      // preflight回避
      headers: { "Content-Type":"text/plain;charset=UTF-8" },
      body: JSON.stringify(body)
    }, timeoutMs);
    const data = await readRes(res);
    if (!res.ok || !data.ok) throw new Error(data.error || `HTTP ${res.status}`);
    return data;
  }

  function sleep(ms){ return new Promise(res=>setTimeout(res, ms)); }

  async function init(){
    setState("初期化中…");
    await liff.init({ liffId: LIFF_ID });
    if (!liff.isLoggedIn()){
      document.getElementById("loginPill").textContent = "未ログイン";
      liff.login();
      return;
    }
    document.getElementById("loginPill").textContent = "ログイン済み";
    accessToken = liff.getAccessToken();

    // whoami
    try{
      const me = await apiGet("whoami", {}, 20000);
      myUserId = me.userId;
      document.getElementById("who").textContent = `user: ${myUserId}`;
    }catch(e){
      document.getElementById("who").textContent = `init error: ${e.message}`;
    }

    // items
    try{
      const r = await apiGet("items", {}, 20000);
      const itemSel = document.getElementById("itemSel");
      itemSel.innerHTML = "";
      r.items.forEach(x=>{
        const opt = document.createElement("option");
        opt.value = x; opt.textContent = x;
        itemSel.appendChild(opt);
      });

      const memo1Sel = document.getElementById("memo1Sel");
      memo1Sel.innerHTML = "";
      r.memo1Options.forEach(x=>{
        const opt = document.createElement("option");
        opt.value = x; opt.textContent = x==="" ? "（なし）" : x;
        memo1Sel.appendChild(opt);
      });
    }catch(e){
      showMsg("msgAdd", `items error: ${e.message}`);
    }

    // default months
    document.getElementById("monthAdd").value = "";
    document.getElementById("monthSum").value = "";
    document.getElementById("monthBd").value = "";
    document.getElementById("monthChart").value = "";

    setState("待機", "good");
  }

  // tabs
  document.querySelectorAll(".tab").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
      btn.classList.add("active");
      const t = btn.dataset.tab;
      ["add","summary","breakdown","chart"].forEach(k=>{
        document.getElementById(`tab-${k}`).style.display = (k===t) ? "" : "none";
      });
      setState("待機", "good");
    });
  });

  // add
  document.getElementById("btnAdd").addEventListener("click", async ()=>{
    hideMsg("msgAdd");
    setState("入力中…");
    const item  = document.getElementById("itemSel").value;
    const amount= Number(document.getElementById("amount").value);
    const memo1 = document.getElementById("memo1Sel").value;
    const memo2 = document.getElementById("memo2").value || "";
    const month = (document.getElementById("monthAdd").value || "").trim();

    try{
      const r = await apiPost({
        op:"add",
        access_token: accessToken,
        item, amount,
        memo1, memo2,
        month: month || null
      }, 30000);
      showMsg("msgAdd", r);
      setState("完了", "good");
    }catch(e){
      showMsg("msgAdd", `add failed: ${e.message}`);
      setState("エラー", "bad");
    }
  });

  // undo
  document.getElementById("btnUndo").addEventListener("click", async ()=>{
    hideMsg("msgAdd");
    setState("取り消し中…");
    try{
      const r = await apiPost({ op:"undo", access_token: accessToken }, 30000);
      showMsg("msgAdd", r);
      setState("完了", "good");
    }catch(e){
      showMsg("msgAdd", `undo failed: ${e.message}`);
      setState("エラー", "bad");
    }
  });

  // summary
  document.getElementById("btnSum").addEventListener("click", async ()=>{
    hideMsg("msgSum");
    setState("取得中…");
    const month = (document.getElementById("monthSum").value || "").trim() || currentYYYYMM();
    try{
      const r = await apiGet("summary", { month }, 30000);
      document.getElementById("overall").textContent = money(r.overall) + "円";

      const body = document.getElementById("sumBody");
      body.innerHTML = "";
      r.rows.forEach(row=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${row.name}</td>
          <td class="num">${money(row.budget)}円</td>
          <td class="num">${money(row.spend)}円</td>
          <td class="num">${money(row.remain)}円</td>
        `;
        body.appendChild(tr);
      });
      setState("完了", "good");
    }catch(e){
      showMsg("msgSum", `summary failed: ${e.message}`);
      setState("エラー", "bad");
    }
  });

  // breakdown
  async function loadBreakdown(){
    hideMsg("msgBd");
    setState("取得中…");
    const month = (document.getElementById("monthBd").value || "").trim() || currentYYYYMM();
    const start = Number(document.getElementById("startBd").value || 0);
    const limit = Number(document.getElementById("limitBd").value || 50);

    try{
      const r = await apiGet("breakdown", { month, start, limit }, 30000);
      const body = document.getElementById("bdBody");
      body.innerHTML = "";
      r.rows.forEach(row=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${row.date}</td>
          <td>${row.item}</td>
          <td class="num">${money(row.amount)}円</td>
          <td>${row.memo1 || ""}</td>
          <td>${row.memo2 || ""}</td>
        `;
        body.appendChild(tr);
      });
      document.getElementById("bdInfo").textContent =
        `表示: ${r.start+1}–${r.start + r.rows.length} / ${r.total}` + (r.hasMore ? `  nextStart=${r.nextStart}` : "");
      document.getElementById("btnBdMore").disabled = !r.hasMore;
      document.getElementById("btnBdMore").dataset.nextStart = r.nextStart;
      setState("完了", "good");
    }catch(e){
      showMsg("msgBd", `breakdown failed: ${e.message}`);
      setState("エラー", "bad");
    }
  }
  document.getElementById("btnBd").addEventListener("click", loadBreakdown);
  document.getElementById("btnBdMore").addEventListener("click", ()=>{
    const ns = Number(document.getElementById("btnBdMore").dataset.nextStart || 0);
    document.getElementById("startBd").value = String(ns);
    loadBreakdown();
  });

  // modal
  const modal = document.getElementById("imgModal");
  const modalImg = document.getElementById("modalImg");
  const modalTitle = document.getElementById("modalTitle");
  document.getElementById("modalClose").addEventListener("click", ()=>modal.classList.remove("show"));
  modal.addEventListener("click", (e)=>{ if (e.target === modal) modal.classList.remove("show"); });
  function openModal(title, src){
    modalTitle.textContent = title || "画像";
    modalImg.src = src;
    modal.classList.add("show");
  }

  // ============================
  // グラフ（安定版）
  // ============================
  const listEl = document.getElementById("chartList");
  const statusEl = document.getElementById("chartStatus");
  const countEl  = document.getElementById("chartCount");
  const progEl   = document.getElementById("chartProg");
  const btnStop  = document.getElementById("btnChartStop");
  const btnRetry = document.getElementById("btnChartRetry");

  let chartRun = { running:false, stop:false, month:"", queue:[], done:0, total:0, failed:[] };

  function setChartUi_(text, tone="muted"){
    statusEl.textContent = text;
    statusEl.style.borderColor =
      tone === "good" ? "rgba(61,220,151,.35)" :
      tone === "bad"  ? "rgba(255,90,122,.35)" :
      "var(--line)";
  }
  function setChartProgress_(done, total){
    countEl.textContent = `${done} / ${total}`;
    const pct = total ? Math.floor((done/total)*100) : 0;
    progEl.style.width = `${pct}%`;
  }
  function clearChartList_(){
    listEl.innerHTML = "";
    setChartUi_("未取得");
    setChartProgress_(0,0);
    hideMsg("msgChart");
  }

  async function fetchChartImageDataUrl_(fileId){
    const qs = new URLSearchParams({ action:"api", op:"chart_image_b64", fileId });
    const url = `${API_BASE}?${qs.toString()}`;
    // 画像はタイムアウト短め（長いとAbort連鎖しやすい）
    const res = await fetchWithTimeout(url, { method:"GET" }, 30000);
    const data = await readRes(res);
    if (!res.ok || !data.ok) throw new Error(data.error || `HTTP ${res.status}`);
    const mime = data.mimeType || "image/jpeg";
    return `data:${mime};base64,${data.b64}`;
  }

  function addChartCard_(title){
    const box = document.createElement("div");
    box.className = "card";
    const t = document.createElement("div");
    t.className = "chartItemTitle";
    t.textContent = title;
    const sk = document.createElement("div");
    sk.className = "chartSkeleton";
    box.appendChild(t);
    box.appendChild(sk);
    listEl.appendChild(box);
    return { box, title, sk };
  }

  async function loadChartListFilesAll_(month){
    // fileId一覧を全部集める（5枚ずつ生成・取得）
    const queue = [];
    let start = 0;
    const limit = 5;

    while(true){
      if (chartRun.stop) break;
      const r = await apiGet("chart_list_files", { month, start, limit }, 60000);

      // 1回目のみ overall を先頭に入れる
      if (start === 0 && r.overallFileId){
        queue.push({ title:"全体残額", fileId:r.overallFileId });
      }

      (r.items || []).forEach(it=>{
        if (it.fileId){
          queue.push({ title: it.title || "項目", fileId: it.fileId });
        } else {
          // fileId空（年シートのチャート不足など）
          queue.push({ title: (it.title || "項目") + "（チャートなし）", fileId: "" });
        }
      });

      if (!r.hasMore) break;
      start = Number(r.nextStart || 0);
      // Spreadsheet負荷軽減
      await sleep(250);
    }
    return queue;
  }

  async function renderChartsSequential_(queue){
    // 表示の骨組みを先に作る
    const cards = queue.map(q => addChartCard_(q.title));

    chartRun.total = queue.length;
    chartRun.done = 0;
    chartRun.failed = [];

    setChartProgress_(0, chartRun.total);

    for (let i=0;i<queue.length;i++){
      if (chartRun.stop) break;
      const q = queue[i];
      const c = cards[i];

      if (!q.fileId){
        // チャートが無い
        c.sk.className = "msg";
        c.sk.textContent = "この項目はチャートが見つかりません（年シート側のチャート不足の可能性）";
        chartRun.done++;
        setChartProgress_(chartRun.done, chartRun.total);
        continue;
      }

      try{
        const src = await fetchChartImageDataUrl_(q.fileId);

        const img = document.createElement("img");
        img.className = "chartImg";
        img.alt = q.title;
        img.src = src;
        img.addEventListener("click", ()=>openModal(q.title, src));

        c.box.replaceChild(img, c.sk);

        chartRun.done++;
        setChartProgress_(chartRun.done, chartRun.total);

        // 連続取得の負荷軽減（Abort/Spreadsheet切断対策）
        await sleep(180);

      }catch(e){
        chartRun.failed.push({ title:q.title, fileId:q.fileId, error:e.message });
        c.sk.className = "msg";
        c.sk.style.color = "#ffb3c1";
        c.sk.textContent = "読み込み失敗: " + e.message;

        chartRun.done++;
        setChartProgress_(chartRun.done, chartRun.total);

        // エラー時は少し長めに待つ
        await sleep(350);
      }
    }
  }

  function updateChartButtons_(){
    btnStop.disabled = !chartRun.running;
    btnRetry.disabled = chartRun.running || (chartRun.failed.length === 0);
  }

  async function runCharts_(month){
    clearChartList_();
    hideMsg("msgChart");

    chartRun.running = true;
    chartRun.stop = false;
    chartRun.month = month;
    chartRun.queue = [];
    chartRun.failed = [];
    updateChartButtons_();

    setState("グラフ取得中…");
    setChartUi_("一覧取得中…");

    try{
      // ① fileId一覧（＋必要分の生成）を全回収
      const queue = await loadChartListFilesAll_(month);
      chartRun.queue = queue;

      setChartUi_("画像ロード中…");
      setChartProgress_(0, queue.length);

      // ② 1枚ずつ base64→表示
      await renderChartsSequential_(queue);

      chartRun.running = false;
      updateChartButtons_();

      if (chartRun.stop){
        setChartUi_("停止しました", "bad");
        setState("停止", "bad");
      } else if (chartRun.failed.length){
        setChartUi_("一部失敗（再試行できます）", "bad");
        setState("一部失敗", "bad");
        showMsg("msgChart", "失敗一覧:\n" + chartRun.failed.map(x=>`- ${x.title}: ${x.error}`).join("\n"));
      } else {
        setChartUi_("完了", "good");
        setState("完了", "good");
      }

    }catch(e){
      chartRun.running = false;
      updateChartButtons_();
      setChartUi_("エラー", "bad");
      setState("エラー", "bad");
      showMsg("msgChart", `chart failed: ${e.message}`);
    }
  }

  // グラフ：一覧表示
  document.getElementById("btnChartList").addEventListener("click", async ()=>{
    const month = (document.getElementById("monthChart").value || "").trim() || currentYYYYMM();
    await runCharts_(month);
  });

  // 停止
  btnStop.addEventListener("click", ()=>{
    chartRun.stop = true;
    setChartUi_("停止要求…", "bad");
    setState("停止要求…", "bad");
  });

  // 再試行（失敗分だけ再ロード）
  btnRetry.addEventListener("click", async ()=>{
    if (chartRun.running) return;
    if (!chartRun.failed.length) return;

    hideMsg("msgChart");
    chartRun.running = true;
    chartRun.stop = false;
    updateChartButtons_();

    setState("再試行中…");
    setChartUi_("失敗分を再試行中…");

    // 失敗分だけキューを作って末尾に追加表示（分かりやすく）
    const retryQueue = chartRun.failed.map(x=>({ title:x.title + "（再試行）", fileId:x.fileId }));
    chartRun.failed = [];

    // そのまま追加レンダ（シーケンシャル）
    await renderChartsSequential_(retryQueue);

    chartRun.running = false;
    updateChartButtons_();

    if (chartRun.stop){
      setChartUi_("停止しました", "bad");
      setState("停止", "bad");
    } else if (chartRun.failed.length){
      setChartUi_("まだ一部失敗（再試行可）", "bad");
      setState("一部失敗", "bad");
      showMsg("msgChart", "失敗一覧:\n" + chartRun.failed.map(x=>`- ${x.title}: ${x.error}`).join("\n"));
    } else {
      setChartUi_("再試行 完了", "good");
      setState("完了", "good");
    }
  });

  // 起動
  init().catch(err=>{
    document.getElementById("who").textContent = `init fatal: ${err.message}`;
    setState("エラー", "bad");
  });
</script>
</body>
</html>
