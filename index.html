<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>家計簿 MiniApp</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<style>
  :root{
    --bg:#f6f7f9;
    --card:#ffffff;
    --text:#111827;
    --muted:#667085;
    --border:#d0d5dd;
    --shadow:0 8px 26px rgba(0,0,0,.08);
    --green:#1DB446;
    --red:#d92d20;
    --gray:#f2f4f7;
  }
  body{margin:0;background:var(--bg);font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;color:var(--text);}
  .wrap{max-width:980px;margin:auto;padding:16px 16px 96px;}
  .card{background:var(--card);border-radius:18px;padding:14px 14px;margin:12px 0;box-shadow:var(--shadow);}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
  .spacer{flex:1;}
  .title{font-weight:900;font-size:18px;letter-spacing:.02em;}
  .pill{display:inline-block;padding:5px 12px;border-radius:999px;background:var(--gray);color:#344054;font-size:12px;font-weight:800;}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;}
  .small{font-size:12px;color:var(--muted);}
  button{height:42px;padding:0 14px;border-radius:12px;border:1px solid var(--border);background:#fff;cursor:pointer;font-weight:800;}
  button:disabled{opacity:.55;cursor:not-allowed;}
  .primary{background:var(--green);border-color:var(--green);color:#fff;}
  .danger{background:#fff;border-color:#f2b8b5;color:var(--red);}
  input,select{height:44px;width:100%;border-radius:12px;border:1px solid var(--border);padding:0 12px;box-sizing:border-box;background:#fff;}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
  @media (max-width:720px){ .grid2{grid-template-columns:1fr;} }

  table{width:100%;border-collapse:collapse;}
  th,td{border-bottom:1px solid #eef2f6;padding:9px 8px;font-size:13px;vertical-align:top;}
  th{color:var(--muted);text-align:left;font-weight:900;}
  .right{text-align:right;}
  .ok{color:#027a48;font-weight:900;}
  .ng{color:#b42318;font-weight:900;}

  .toast{padding:10px 12px;border:1px solid #e6e8ee;border-radius:14px;background:#fafbff}
</style>
</head>

<body>
<div class="wrap">

  <!-- Header / Month -->
  <div class="card">
    <div class="row">
      <div class="title">家計簿</div>
      <div class="spacer"></div>
      <span class="pill" id="monthLabel">----</span>
    </div>

    <div style="height:10px"></div>

    <div class="grid2">
      <div class="row">
        <button id="btnThisMonth" onclick="setMonthToThis()" disabled>今月</button>
        <button id="btnPrevMonth" onclick="setMonthToPrev()" disabled>先月</button>
        <button id="btnReload" onclick="refreshAll()" disabled>再読み込み</button>
      </div>
      <div class="row">
        <div style="flex:1;min-width:180px">
          <div class="small">YYYYMM 指定</div>
          <input id="ymInput" placeholder="例：202510" inputmode="numeric">
        </div>
        <button class="primary" id="btnApplyYm" onclick="applyYm()" disabled>適用</button>
      </div>
    </div>

    <div style="height:10px"></div>
    <div id="status" class="mono">初期化中…</div>
    <div class="small mono" id="detail"></div>

    <div style="height:8px"></div>
    <div class="row">
      <button onclick="copyDebug()">デバッグコピー</button>
      <button onclick="whoami()">whoami</button>
      <button onclick="ping()">ping</button>
      <div class="spacer"></div>
      <span class="small" id="loginName"></span>
    </div>

    <div style="height:8px"></div>
    <div class="toast">
      <div class="small">デバッグ表示</div>
      <div class="mono small" id="debugBox">-</div>
    </div>
  </div>

  <!-- Input -->
  <div class="card">
    <div class="row" style="margin-bottom:10px">
      <b>入力</b>
      <div class="spacer"></div>
      <span class="small">追加成功後のみ「取り消し」できます</span>
    </div>

    <div class="row">
      <div style="flex:2;min-width:220px">
        <div class="small">項目</div>
        <select id="item"></select>
      </div>
      <div style="flex:1;min-width:160px">
        <div class="small">金額</div>
        <input id="amount" inputmode="numeric" placeholder="例：1200">
      </div>
      <div style="flex:1;min-width:180px">
        <div class="small">メモ1（固定）</div>
        <select id="memo1">
          <option>かずき</option>
          <option>かずきカード</option>
          <option>みく</option>
          <option>みくカード</option>
        </select>
      </div>
    </div>

    <div style="height:10px"></div>
    <div class="small">メモ2</div>
    <input id="memo2" placeholder="例：昼ごはん / ドラッグストア など">

    <div style="height:12px"></div>
    <div class="row">
      <button class="primary" id="btnAdd" onclick="add()" disabled>追加</button>
      <button class="danger" id="btnUndo" onclick="undo()" disabled>取り消し</button>
      <div class="spacer"></div>
      <span class="small mono" id="lastOp"></span>
    </div>
  </div>

  <!-- Summary -->
  <div class="card">
    <div class="row">
      <b>サマリ</b>
      <div class="spacer"></div>
      <span class="small">予算 / 支出 / 残額</span>
    </div>

    <div style="height:10px"></div>
    <table>
      <thead>
        <tr>
          <th>項目</th>
          <th class="right">予算</th>
          <th class="right">支出</th>
          <th class="right">残額</th>
        </tr>
      </thead>
      <tbody id="summaryBody">
        <tr><td colspan="4" class="small">未取得</td></tr>
      </tbody>
    </table>

    <div style="height:8px"></div>
    <div class="small mono" id="summaryHint"></div>
  </div>

  <!-- Breakdown -->
  <div class="card">
    <div class="row">
      <b>明細</b>
      <div class="spacer"></div>
      <span class="small">日付：mm月dd日</span>
    </div>

    <div style="height:10px"></div>
    <table>
      <thead>
        <tr>
          <th style="width:86px">日付</th>
          <th>項目</th>
          <th class="right" style="width:96px">金額</th>
          <th>メモ</th>
        </tr>
      </thead>
      <tbody id="breakdownBody">
        <tr><td colspan="4" class="small">未取得</td></tr>
      </tbody>
    </table>

    <div style="height:8px"></div>
    <div class="small mono" id="breakdownHint"></div>
  </div>

</div>

<script>
  // ====== 設定（あなたのWebApp URL & LIFF ID）======
  // ★ /exec になっていることを確認（/dev だと不安定になりがち）
  const GAS  = "https://script.google.com/macros/s/AKfycbwCRPyhJLCWkw_F-pm177DGUgq2R_sTVPZLzXuotaJZ6B6R53vDBVpuKXUfYb_N6P_2Eg/exec";
  const LIFF_ID = "2008812269-var864Dv";

  // ====== 状態 ======
  let accessToken = null;
  let profile = null;
  let selectedMonth = null; // "YYYYMM"
  let lastAddSucceeded = false;
  let lastOpName = "";
  let isBusy = false;

  // ====== DOM ======
  const $ = (id)=>document.getElementById(id);

  function setStatus(text, ok=null){
    const el = $("status");
    el.textContent = text;
    el.className = "mono " + (ok===null ? "" : (ok ? "ok" : "ng"));
  }
  function setDetail(text){ $("detail").textContent = text || ""; }
  function setLastOp(s){ lastOpName = s; $("lastOp").textContent = s ? `last: ${s}` : ""; }

  function setBusy(on){
    isBusy = !!on;
    // 操作衝突を防止
    $("btnReload").disabled = on || !accessToken;
    $("btnThisMonth").disabled = on || !accessToken;
    $("btnPrevMonth").disabled = on || !accessToken;
    $("btnApplyYm").disabled  = on || !accessToken;
    $("btnAdd").disabled      = on || !accessToken;
    // undoは lastAddSucceeded のときだけ
    $("btnUndo").disabled     = on || !lastAddSucceeded;
  }

  // ====== month helpers ======
  function ymNow(){
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    return `${y}${m}`;
  }
  function ymPrev(ym){
    const y = Number(ym.slice(0,4));
    const m = Number(ym.slice(4,6));
    const d = new Date(y, m-1, 1);
    d.setMonth(d.getMonth()-1);
    const yy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,'0');
    return `${yy}${mm}`;
  }
  function labelFromYM(ym){
    const y = Number(ym.slice(0,4));
    const m = Number(ym.slice(4,6));
    return `${y}年${m}月`;
  }
  function setMonth(ym){
    selectedMonth = ym;
    $("monthLabel").textContent = labelFromYM(ym);
    $("ymInput").value = ym;
    refreshAll();
  }
  function setMonthToThis(){ setMonth(ymNow()); }
  function setMonthToPrev(){ setMonth(ymPrev(ymNow())); }

  function applyYm(){
    const ym = String($("ymInput").value||"").trim();
    if(!/^\d{6}$/.test(ym)){
      setStatus("YYYYMM が不正です", false);
      setDetail("例：202510 のように 6桁で入力してください");
      return;
    }
    setMonth(ym);
  }

  // ====== formatting ======
  function fmtNum(n){
    const x = Number(n);
    if(!Number.isFinite(x)) return String(n ?? "");
    return x.toLocaleString();
  }
  function formatMMDD(any){
    const s = String(any ?? "");
    const m = s.match(/(\d{4})[\/\-\.](\d{2})[\/\-\.](\d{2})/);
    if(m) return `${Number(m[2])}月${Number(m[3])}日`;
    const d = new Date(s);
    if(!isNaN(d.getTime())) return `${d.getMonth()+1}月${d.getDate()}日`;
    return s;
  }
  function escapeHtml(s){
    return String(s ?? "")
      .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;").replace(/'/g,"&#39;");
  }

  // ====== HTTP（ここが重要：必ず text を確保して原因を出す） ======
  async function fetchJson(url, opt={}){
    const res = await fetch(url, {
      cache:"no-store",
      ...opt
    });

    const text = await res.text();
    let json = null;
    try { json = JSON.parse(text); } catch {}

    // 200でなくても、JSONでなくても、とにかく情報を返す
    if (!res.ok){
      return {
        ok:false,
        error:"http_error",
        status: res.status,
        statusText: res.statusText,
        url,
        body: text
      };
    }
    if (!json){
      return {
        ok:false,
        error:"non_json_response",
        status: res.status,
        url,
        body: text
      };
    }
    return json;
  }

  async function getJson(url){
    return fetchJson(url, { method:"GET" });
  }

  async function postJson(body){
    return fetchJson(GAS + "?action=api", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(body)
    });
  }

  // ====== API wrappers ======
  function apiUrl(op, params={}){
    const qs = new URLSearchParams({
      action:"api",
      op,
      access_token: accessToken || "",
      ...params
    });
    return `${GAS}?${qs.toString()}`;
  }

  // ====== UI helpers ======
  function setUndoEnabled(on){
    lastAddSucceeded = !!on;
    $("btnUndo").disabled = !lastAddSucceeded || isBusy;
  }

  function setDebug(obj){
    $("debugBox").textContent = JSON.stringify(obj, null, 2);
  }

  function showApiError_(title, r, url){
    const msg = (r && (r.error || r.msg)) || "unknown";
    const body = (r && r.body) ? String(r.body).slice(0, 500) : "";
    const s = [
      title,
      `error: ${msg}`,
      r && r.status ? `status: ${r.status} ${r.statusText || ""}` : "",
      url ? `url: ${url}` : "",
      body ? `body(first500): ${body}` : ""
    ].filter(Boolean).join(" / ");

    setStatus(title, false);
    setDetail(s);
    setDebug({ title, response: r, url });
  }

  // ====== loaders ======
  async function loadItems(){
    const sel = $("item");
    sel.innerHTML = "";

    const url = apiUrl("items");
    const r = await getJson(url);

    if(!r || r.ok !== true){
      // 固定候補でフォールバック
      const fallback = [
        '住居費','駐車場代','貯金','食費','外食費','日用品費','その他生活費',
        '電気','ガス','水道','通信費（携帯電話）','通信費（電話・インターネット・その他）',
        '交通費','散髪代・美容費','衣服・靴','医療費','交際費','おこづかい',
        '生命保険・医療保険費用','ガソリン代','車の費用（ガソリン以外）',
        'レジャー費','その他（上記に含まれないもの）','その他（その月特別にかかる費用）','お酒'
      ];
      fallback.forEach(v=>{
        const o=document.createElement("option");
        o.value=v; o.textContent=v;
        sel.appendChild(o);
      });
      $("summaryHint").textContent = "items取得失敗のため固定リストで表示中";
      // どの理由で落ちたかは detail / debug に出す
      setDebug({ op:"items", response:r, url });
      return false;
    }

    (r.items || []).forEach(v=>{
      const o=document.createElement("option");
      o.value=v; o.textContent=v;
      sel.appendChild(o);
    });
    return true;
  }

  async function loadSummary(){
    const tb = $("summaryBody");
    const hint = $("summaryHint");
    tb.innerHTML = `<tr><td colspan="4" class="small">読み込み中…</td></tr>`;
    hint.textContent = "";

    const url = apiUrl("summary", { month: selectedMonth });
    const r = await getJson(url);

    if(!r || r.ok !== true){
      tb.innerHTML = `<tr><td colspan="4" class="small">取得失敗：${escapeHtml((r&&(r.error||r.msg))||"unknown")}</td></tr>`;
      hint.textContent = `url: ${url}`;
      setDebug({ op:"summary", response:r, url });
      return false;
    }

    const rows = r.rows || [];
    if(rows.length === 0){
      tb.innerHTML = `<tr><td colspan="4" class="small">データなし（${escapeHtml(r.month || selectedMonth)}）</td></tr>`;
      hint.textContent = `overall: ${fmtNum(r.overall ?? "")}`;
      return true;
    }

    tb.innerHTML = "";
    rows.forEach(it=>{
      const budget = Number(it.budget || 0);
      const spend  = Number(it.spend  || 0);
      const remain = Number(it.remain || 0);
      tb.innerHTML += `
        <tr>
          <td>${escapeHtml(it.name || "")}</td>
          <td class="right">${escapeHtml(fmtNum(budget))}</td>
          <td class="right">${escapeHtml(fmtNum(spend))}</td>
          <td class="right">${escapeHtml(fmtNum(remain))}</td>
        </tr>
      `;
    });

    hint.textContent = `month: ${r.month || selectedMonth} / overall: ${fmtNum(r.overall ?? 0)}`;
    return true;
  }

  async function loadBreakdown(){
    const tb = $("breakdownBody");
    const hint = $("breakdownHint");
    tb.innerHTML = `<tr><td colspan="4" class="small">読み込み中…</td></tr>`;
    hint.textContent = "";

    const url = apiUrl("breakdown", { month: selectedMonth, start: 0, limit: 200 });
    const r = await getJson(url);

    if(!r || r.ok !== true){
      tb.innerHTML = `<tr><td colspan="4" class="small">取得失敗：${escapeHtml((r&&(r.error||r.msg))||"unknown")}</td></tr>`;
      hint.textContent = `url: ${url}`;
      setDebug({ op:"breakdown", response:r, url });
      return false;
    }

    const rows = r.rows || [];
    if(rows.length === 0){
      tb.innerHTML = `<tr><td colspan="4" class="small">明細なし（${escapeHtml(r.month || selectedMonth)}）</td></tr>`;
      hint.textContent = `total: ${r.total ?? 0}`;
      return true;
    }

    tb.innerHTML = "";
    rows.forEach(v=>{
      const date = formatMMDD(v.date);
      const memo = `${v.memo1||""} ${v.memo2||""}`.trim();
      tb.innerHTML += `
        <tr>
          <td>${escapeHtml(date)}</td>
          <td>${escapeHtml(v.item || "")}</td>
          <td class="right">${escapeHtml(fmtNum(v.amount ?? ""))}</td>
          <td>${escapeHtml(memo)}</td>
        </tr>
      `;
    });

    hint.textContent = `month: ${r.month || selectedMonth} / rows: ${rows.length} / total: ${r.total ?? ""}`;
    return true;
  }

  async function refreshAll(){
    if(!accessToken){
      setStatus("access_token がありません", false);
      setDetail("LINEアプリ内で開いているか、ログイン状態を確認してください");
      return;
    }
    if(!selectedMonth){
      selectedMonth = ymNow();
      $("monthLabel").textContent = labelFromYM(selectedMonth);
      $("ymInput").value = selectedMonth;
    }

    setBusy(true);
    setStatus("読み込み中…");
    setDetail("");

    try{
      await loadItems();
      const [a,b] = await Promise.all([loadSummary(), loadBreakdown()]);
      if(a && b){
        setStatus("表示更新OK", true);
        setDetail("");
      }else{
        setStatus("一部取得失敗（debugBox参照）", false);
        setDetail("summary/breakdown/items のどこかが落ちています。debugBoxの response を見てください。");
      }
    }catch(e){
      setStatus("読み込みエラー", false);
      setDetail(String(e && e.message ? e.message : e));
      setDebug({ op:"refreshAll", error:String(e), stack:e && e.stack ? String(e.stack) : null });
    }finally{
      setBusy(false);
    }
  }

  // ====== Add / Undo ======
  function parseAmountInput(s){
    const t = String(s||"").trim();
    if(!t) return NaN;
    const cleaned = t.replace(/,/g,"");
    const n = Number(cleaned);
    return Number.isFinite(n) ? n : NaN;
  }

  async function add(){
    if(isBusy) return;

    const item = $("item").value;
    const amount = parseAmountInput($("amount").value);
    const memo1 = $("memo1").value;
    const memo2 = $("memo2").value;

    setLastOp("add");
    setUndoEnabled(false);

    if(!item || !Number.isFinite(amount)){
      setStatus("入力が不正です", false);
      setDetail("項目と金額を確認してください");
      return;
    }

    setBusy(true);
    setStatus("追加中…");
    setDetail("");

    try {
      const r = await postJson({
        op:"add",
        access_token: accessToken,
        item, amount, memo1, memo2
      });

      if (r && r.ok === true) {
        setStatus("追加OK", true);
        setDetail(r.msg || "");
        setUndoEnabled(true);

        $("amount").value = "";
        $("memo2").value = "";

        await refreshAll();
      } else {
        // ここで「何が返ってきたか」をdetail/debugに必ず出す
        showApiError_("追加NG", r, GAS + "?action=api (POST)");
        setUndoEnabled(false);
      }
    } catch (e) {
      setStatus("追加NG（例外）", false);
      setDetail(String(e && e.message ? e.message : e));
      setDebug({ op:"add", exception:String(e), stack:e && e.stack ? String(e.stack) : null });
      setUndoEnabled(false);
    } finally {
      setBusy(false);
    }
  }

  async function undo(){
    if(isBusy) return;
    if(!lastAddSucceeded) return;

    setBusy(true);
    setStatus("取り消し中…");
    setDetail("");
    setLastOp("undo");

    try{
      const r = await postJson({ op:"undo", access_token: accessToken });

      if(r && r.ok === true){
        setStatus("取り消しOK", true);
        setDetail(r.msg || "");
        setUndoEnabled(false);
        await refreshAll();
      }else{
        showApiError_("取り消しNG", r, GAS + "?action=api (POST)");
        // 失敗時は再試行できるように戻す
        setUndoEnabled(true);
      }
    }catch(e){
      setStatus("取り消しNG（例外）", false);
      setDetail(String(e && e.message ? e.message : e));
      setDebug({ op:"undo", exception:String(e), stack:e && e.stack ? String(e.stack) : null });
      setUndoEnabled(true);
    }finally{
      setBusy(false);
    }
  }

  // ====== Debug helpers ======
  async function whoami(){
    try{
      if(!accessToken){
        setStatus("whoami NG", false);
        setDetail("access_token がありません");
        return;
      }
      const url = apiUrl("whoami");
      const r = await getJson(url);
      setDebug({ op:"whoami", response:r, url });

      if(r && r.ok){
        setStatus("whoami OK", true);
        setDetail(r.userId || "");
      }else{
        showApiError_("whoami NG", r, url);
      }
    }catch(e){
      setStatus("whoami エラー", false);
      setDetail(String(e && e.message ? e.message : e));
    }
  }

  async function ping(){
    // GAS側に op=ping を追加していない場合は unknown op になるけど、それでも生存確認にはなる
    try{
      const url = `${GAS}?action=api&op=ping&access_token=${encodeURIComponent(accessToken||"")}`;
      const r = await getJson(url);
      setDebug({ op:"ping", response:r, url });
      if(r && r.ok) setStatus("ping OK", true);
      else setStatus("ping NG（debugBox参照）", false);
      setDetail("");
    }catch(e){
      setStatus("ping エラー", false);
      setDetail(String(e && e.message ? e.message : e));
    }
  }

  async function copyDebug(){
    const info = {
      gas: GAS,
      selectedMonth,
      monthLabel: $("monthLabel").textContent,
      isLoggedIn: (typeof liff !== "undefined" && liff.isLoggedIn) ? liff.isLoggedIn() : null,
      isInClient: (typeof liff !== "undefined" && liff.isInClient) ? liff.isInClient() : null,
      hasAccessToken: !!accessToken,
      profile: profile ? { displayName: profile.displayName, userId: profile.userId } : null,
      lastOp: lastOpName,
      busy: isBusy
    };
    try{
      await navigator.clipboard.writeText(JSON.stringify(info,null,2));
      setStatus("デバッグコピーOK", true);
      setDetail("");
      setDebug(info);
    }catch{
      setStatus("コピー失敗（ブラウザ制限かも）", false);
      setDetail("");
      setDebug(info);
    }
  }

  // ====== init ======
  async function init(){
    setStatus("LIFF 初期化中…");
    setDetail("");
    setDebug({ phase:"init-start" });

    try{
      await liff.init({ liffId: LIFF_ID });
    }catch(e){
      setStatus("LIFF init 失敗", false);
      setDetail(String(e && e.message ? e.message : e));
      setDebug({ phase:"liff.init", error:String(e), stack:e && e.stack ? String(e.stack) : null });
      return;
    }

    if(!liff.isLoggedIn()){
      // LINEログインへ
      liff.login();
      return;
    }

    accessToken = liff.getAccessToken();
    try { profile = await liff.getProfile(); } catch { profile = null; }

    $("loginName").textContent = profile ? `ログイン：${profile.displayName}` : "ログイン：-";

    // 初期：今月
    selectedMonth = ymNow();
    $("monthLabel").textContent = labelFromYM(selectedMonth);
    $("ymInput").value = selectedMonth;

    // UI enable
    setBusy(false);

    setStatus("ログインOK（今月を読み込みます）", true);
    setDetail("");
    setDebug({
      phase:"ready",
      selectedMonth,
      profile: profile ? { displayName: profile.displayName, userId: profile.userId } : null,
      hasAccessToken: !!accessToken
    });

    await refreshAll();
  }

  window.addEventListener("load", init);
</script>
</body>
</html>
