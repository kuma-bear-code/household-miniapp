<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>家計簿 MiniApp</title>

  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif; margin: 16px; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 12px; margin-bottom: 12px; }
    .row { display: flex; gap: 8px; flex-wrap: wrap; }
    label { font-size: 12px; color: #444; display:block; margin-bottom: 4px; }
    input, select, textarea, button { font-size: 16px; padding: 10px; border-radius: 10px; border: 1px solid #ccc; }
    input, select, textarea { width: 100%; box-sizing: border-box; }
    button { cursor: pointer; border: 1px solid #333; background: #111; color: #fff; }
    button.secondary { background: #fff; color: #111; }
    button:disabled { opacity: .5; cursor: not-allowed; }
    .w50 { flex: 1 1 160px; }
    .status { font-size: 13px; color: #333; white-space: pre-wrap; }
    img { width: 100%; border-radius: 12px; border: 1px solid #eee; }
    .muted { color:#777; font-size: 12px; }
    .small { font-size: 12px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>

<body>
  <!-- 設定（埋め込み済み） -->
  <div class="card">
    <div class="row">
      <div class="w50">
        <label>WebApp URL（固定）</label>
        <input id="apiUrl" readonly />
        <div class="muted small mono" id="apiUrlHint"></div>
      </div>
      <div class="w50">
        <label>LIFF ID（固定）</label>
        <input id="liffId" readonly />
        <div class="muted small mono" id="liffHint"></div>
      </div>
    </div>

    <div class="row" style="margin-top:10px;">
      <div class="w50">
        <label>対象年月（yyyymm）</label>
        <input id="yyyymm" placeholder="202601" />
        <div class="muted">例：202601（yyyymm内訳 / 月シート 202601 を参照）</div>
      </div>

      <div class="w50">
        <label>ログイン状態</label>
        <input id="liffState" readonly />
        <div class="muted" id="profileHint"></div>
      </div>
    </div>
  </div>

  <!-- 入力 -->
  <div class="card">
    <div class="row">
      <div class="w50">
        <label>項目</label>
        <input id="item" placeholder="食費" />
      </div>
      <div class="w50">
        <label>金額</label>
        <input id="amount" type="number" placeholder="1200" />
      </div>
    </div>

    <div class="row">
      <div class="w50">
        <label>備考1</label>
        <input id="note1" placeholder="スーパー" />
      </div>
      <div class="w50">
        <label>備考2</label>
        <input id="note2" placeholder="メモ" />
      </div>
    </div>

    <div class="row" style="margin-top:10px;">
      <button id="btnAdd" disabled>追加</button>
      <button id="btnUndo" class="secondary" disabled>取消（直前txId）</button>
      <button id="btnRefresh" class="secondary" disabled>更新（Summary/Chart）</button>
    </div>

    <div class="muted" style="margin-top:8px;">
      取消は txId に紐づくUNDO行を <span class="mono">yyyymm内訳</span> に追記（監査・集計が安定）。
      BOTが「行削除」方式ならGAS側undo_を合わせてください。
    </div>
  </div>

  <!-- 状態 -->
  <div class="card">
    <div class="row">
      <div class="w50">
        <label>Summary（E39）</label>
        <input id="summary" readonly />
      </div>
      <div class="w50">
        <label>直前 txId</label>
        <input id="lastTxId" readonly />
      </div>
    </div>
    <div class="status" id="status"></div>
  </div>

  <!-- グラフ -->
  <div class="card">
    <label>残額グラフ（1枚取得API）</label>
    <img id="chart" alt="chart" />
    <div class="muted" id="chartMeta"></div>
  </div>

<script>
  // ===== 固定値：あなたが指定したものを埋め込み =====
  const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbwCRPyhJLCWkw_F-pm177DGUgq2R_sTVPZLzXuotaJZ6B6R53vDBVpuKXUfYb_N6P_2Eg/exec";
  const LIFF_ID    = "2008812269-var864Dv";

  // ====== UI helpers ======
  const $ = (id) => document.getElementById(id);

  function setStatus(msg) {
    $("status").textContent = msg;
  }

  function setButtonsEnabled(enabled) {
    $("btnAdd").disabled = !enabled;
    $("btnUndo").disabled = !enabled;
    $("btnRefresh").disabled = !enabled;
  }

  // ====== API call wrapper ======
  async function apiCall(op, payload) {
    const res = await fetch(WEBAPP_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ op, payload })
    });
    const json = await res.json();
    if (!json.ok) throw new Error(json.error || "API error");
    return json;
  }

  async function refreshSummaryAndChart() {
    const yyyymm = $("yyyymm").value.trim();
    if (!yyyymm) throw new Error("yyyymm が未入力です");

    // summary (E39)
    const s = await apiCall("getSummary", { yyyymm });
    $("summary").value = String(s.value ?? "");

    // chart (ONE)
    const c = await apiCall("getChartOne", { yyyymm, name: "残額" });
    const img = $("chart");
    if (c.found && c.dataUrl) {
      img.src = c.dataUrl;
      $("chartMeta").textContent = `fileId=${c.fileId} updated=${c.updated}`;
    } else {
      img.removeAttribute("src");
      $("chartMeta").textContent = "画像が見つかりませんでした（フォルダ/命名規則を確認）";
    }
  }

  // ====== Actions ======
  async function onAdd() {
    try {
      setStatus("追加中...");
      const yyyymm = $("yyyymm").value.trim();
      const item   = $("item").value.trim();
      const amount = Number($("amount").value);
      const note1  = $("note1").value;
      const note2  = $("note2").value;

      const r = await apiCall("add", { yyyymm, item, amount, note1, note2, source: "miniapp" });
      $("lastTxId").value = r.txId;

      // ★UX安定：操作直後に必ず1枚取得APIで更新
      await refreshSummaryAndChart();
      setStatus(`追加OK txId=${r.txId}`);
    } catch (e) {
      setStatus("追加失敗: " + e.message);
    }
  }

  async function onUndo() {
    try {
      setStatus("取消中...");
      const yyyymm = $("yyyymm").value.trim();
      const txId   = $("lastTxId").value.trim();
      if (!txId) throw new Error("直前txIdが空です");

      const r = await apiCall("undo", { yyyymm, txId, source: "miniapp" });

      // ★ここも必ず更新
      await refreshSummaryAndChart();
      setStatus(`取消OK txId=${r.txId}`);
    } catch (e) {
      setStatus("取消失敗: " + e.message);
    }
  }

  async function onRefresh() {
    try {
      setStatus("更新中...");
      await refreshSummaryAndChart();
      setStatus("更新OK");
    } catch (e) {
      setStatus("更新失敗: " + e.message);
    }
  }

  // ====== LIFF init ======
  async function initLiff() {
    $("apiUrl").value = WEBAPP_URL;
    $("liffId").value = LIFF_ID;
    $("apiUrlHint").textContent = WEBAPP_URL;
    $("liffHint").textContent = LIFF_ID;

    try {
      setStatus("LIFF 初期化中...");
      await liff.init({ liffId: LIFF_ID });

      const inClient = liff.isInClient();
      const loggedIn = liff.isLoggedIn();

      if (!loggedIn) {
        $("liffState").value = "未ログイン";
        $("profileHint").textContent = "LIFFログインします（外部ブラウザの場合はログイン画面に遷移）";
        // ログインが必要なら実行
        liff.login({ redirectUri: window.location.href });
        return;
      }

      // Logged in
      $("liffState").value = inClient ? "LINE内（ログイン済）" : "外部ブラウザ（ログイン済）";
      setButtonsEnabled(true);

      // 任意：プロフィール表示（取れない場合もあるのでtry）
      try {
        const profile = await liff.getProfile();
        $("profileHint").textContent = `ユーザー: ${profile.displayName}`;
      } catch {
        $("profileHint").textContent = "プロフィール取得はスキップ";
      }

      setStatus("準備完了");

      // 任意：yyyymmが入っていたら初期更新
      if ($("yyyymm").value.trim()) {
        await onRefresh();
      }
    } catch (e) {
      // LIFFが使えない環境でも動作だけはさせたいなら、ここでボタン有効化も可能
      $("liffState").value = "LIFF初期化失敗";
      $("profileHint").textContent = "この環境でLIFFが使えない可能性。LINE内で開いてください。";
      setButtonsEnabled(false);
      setStatus("LIFF初期化失敗: " + e.message);
    }
  }

  // ====== Bind UI ======
  window.addEventListener("load", () => {
    $("btnAdd").addEventListener("click", onAdd);
    $("btnUndo").addEventListener("click", onUndo);
    $("btnRefresh").addEventListener("click", onRefresh);
    initLiff();
  });
</script>

</body>
</html>
