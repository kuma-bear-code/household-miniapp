<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>家計簿ミニアプリ</title>

  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif; margin: 16px; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 12px; margin: 12px 0; }
    .row { display: flex; gap: 8px; flex-wrap: wrap; }
    button { padding: 10px 12px; border-radius: 10px; border: 1px solid #ccc; background: #fff; cursor: pointer; }
    button.primary { background: #1DB446; color: #fff; border-color: #1DB446; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    pre { background:#111; color:#ddd; padding:12px; border-radius:12px; overflow:auto; }
    .muted { color:#666; font-size: 12px; }
    .ok { color:#1b8f3a; font-weight: 700; }
    .ng { color:#c62828; font-weight: 700; }
    input { padding:10px 12px; border-radius:10px; border:1px solid #ccc; width: 100%; box-sizing: border-box;}
  </style>
</head>

<body>
  <h2>家計簿ミニアプリ</h2>
  <div class="muted">
    LINEログイン後、自動で本人確認を行います。
  </div>

  <div class="card">
    <div><b>ステータス</b></div>
    <div id="status">初期化中…</div>
    <div class="muted" id="detail"></div>
  </div>

  <div class="card">
    <div class="row">
      <button class="primary" id="btnWhoami" onclick="whoami()" disabled>本人確認</button>
      <button id="btnSummary" onclick="loadSummary()" disabled>今月サマリ</button>
      <button id="btnClose" onclick="closeLiff()" disabled>閉じる</button>
    </div>
  </div>

  <div class="card">
    <div><b>レスポンス</b></div>
    <pre id="output">（ここに結果が出ます）</pre>
  </div>

<script>
  // ===== 固定 =====
  const GAS_URL  = "https://script.google.com/macros/s/AKfycbwCRPyhJLCWkw_F-pm177DGUgq2R_sTVPZLzXuotaJZ6B6R53vDBVpuKXUfYb_N6P_2Eg/exec";
  const LIFF_ID = "2008812269-var864Dv";

  // ===== 状態 =====
  let accessToken = null;
  let profile = null;

  // ===== UI =====
  const $ = id => document.getElementById(id);
  function setStatus(text, ok=null){
    const el = $("status");
    el.textContent = text;
    el.className = ok === null ? "" : (ok ? "ok" : "ng");
  }
  function setDetail(text){ $("detail").textContent = text || ""; }
  function setOutput(obj){
    $("output").textContent = JSON.stringify(obj, null, 2);
  }
  function enableButtons(){
    $("btnWhoami").disabled = false;
    $("btnSummary").disabled = false;
    $("btnClose").disabled = false;
  }

  // ===== 初期化 =====
  async function init(){
    try {
      setStatus("LIFF 初期化中…");
      await liff.init({ liffId: LIFF_ID });

      // 未ログインなら即ログイン（自動リダイレクト）
      if (!liff.isLoggedIn()) {
        liff.login({ redirectUri: location.href });
        return;
      }

      accessToken = liff.getAccessToken();
      profile = await liff.getProfile();

      setStatus("ログイン完了", true);
      setDetail(`こんにちは、${profile.displayName} さん`);
      enableButtons();

      // 起動時に本人確認を一度走らせるならここ
      // await whoami();

    } catch (e) {
      setStatus("初期化エラー", false);
      setDetail(String(e));
      setOutput({ error: String(e) });
    }
  }

  // ===== GAS 呼び出し =====
  async function fetchJson(url){
    const res = await fetch(url, { cache:"no-store" });
    return await res.json();
  }

  async function whoami(){
    setStatus("本人確認中…");
    const url = `${GAS_URL}?action=api&op=whoami&access_token=${encodeURIComponent(accessToken)}`;
    const json = await fetchJson(url);
    setOutput(json);

    if (json.ok) {
      setStatus("本人確認OK", true);
      setDetail(`userId: ${json.userId}`);
    } else {
      setStatus("本人確認NG", false);
      setDetail(json.error || "");
    }
  }

  async function loadSummary(){
    setStatus("サマリ取得中…");
    const url = `${GAS_URL}?action=api&op=summary&access_token=${encodeURIComponent(accessToken)}`;
    const json = await fetchJson(url);
    setOutput(json);

    if (json.ok) {
      setStatus("サマリ取得OK", true);
    } else {
      setStatus("サマリ取得NG", false);
    }
  }

  function closeLiff(){
    if (liff.isInClient()) liff.closeWindow();
  }

  window.addEventListener("load", init);
</script>

</body>
</html>
